<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>职业理想词云</title>
    <!-- 引入外部资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.0/dist/av-min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud2.js@1.2.1/src/wordcloud2.min.js"></script>
    
    <!-- 配置Tailwind自定义颜色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                    },
                }
            }
        }
    </script>
</head>
<body class="bg-gray-50 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-6 max-w-5xl">
        <!-- 页面标题 -->
        <header class="text-center mb-8">
            <h1 class="text-[clamp(1.8rem,5vw,3rem)] font-bold text-gray-800 mb-2">职业理想词云</h1>
            <p class="text-gray-600 text-[clamp(1rem,2vw,1.2rem)]">分享你的职业理想，共创班级梦想图谱</p>
        </header>

        <!-- 输入区域 -->
        <div class="bg-white rounded-xl shadow-md p-5 mb-6 transform transition-all hover:shadow-lg">
            <div class="flex flex-col sm:flex-row gap-3">
                <input 
                    type="text" 
                    id="idealInput" 
                    placeholder="输入代表你职业理想的词（如：自由、创新）" 
                    class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary/50 transition-all"
                    maxlength="10"
                >
                <button 
                    id="submitBtn" 
                    class="bg-primary hover:bg-primary/90 text-white font-medium px-6 py-3 rounded-lg transition-all duration-300 flex items-center justify-center gap-2"
                >
                    <i class="fa fa-paper-plane"></i>
                    <span>提交</span>
                </button>
            </div>
            <p id="message" class="mt-3 text-sm text-gray-500 hidden"></p>
        </div>

        <!-- 弹幕区域 -->
        <div id="danmakuContainer" class="bg-white rounded-xl shadow-md p-4 mb-6 h-40 overflow-hidden relative">
            <h2 class="text-xl font-semibold mb-2 text-gray-800 flex items-center">
                <i class="fa fa-comment-o text-primary mr-2"></i>实时弹幕
            </h2>
            <div id="danmakuArea" class="w-full h-full relative">
                <!-- 弹幕会动态添加到这里 -->
            </div>
        </div>

        <!-- 词云区域 -->
        <div class="bg-white rounded-xl shadow-md p-5">
            <h2 class="text-xl font-semibold mb-4 text-gray-800 flex items-center">
                <i class="fa fa-cloud text-accent mr-2"></i>班级职业理想词云
            </h2>
            <div class="w-full h-[clamp(250px,50vw,400px)] relative">
                <canvas id="wordcloudCanvas" class="w-full h-full"></canvas>
                <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                    <i class="fa fa-cloud text-5xl mb-3 opacity-30"></i>
                    <p>等待大家的职业理想...</p>
                </div>
            </div>
        </div>

        <footer class="mt-8 text-center text-gray-500 text-sm p-4">
            <p>每个人只能提交一次，请认真思考你的职业理想</p>
        </footer>
    </div>

    <script>
        // 初始化LeanCloud - 请替换为您的实际appID和appKEY
        AV.init({
            appId: "你的appID",
            appKey: "你的appKEY",
            serverURL: "https://api.leancloud.cn"
        });

        // 获取CareerIdealWord类
        const CareerIdealWord = AV.Object.extend('CareerIdealWord');
        const query = new AV.Query(CareerIdealWord);

        // DOM元素
        const idealInput = document.getElementById('idealInput');
        const submitBtn = document.getElementById('submitBtn');
        const message = document.getElementById('message');
        const danmakuArea = document.getElementById('danmakuArea');
        const wordcloudCanvas = document.getElementById('wordcloudCanvas');
        const emptyState = document.getElementById('emptyState');

        // 检查用户是否已提交
        let hasSubmitted = false;
        let userId = localStorage.getItem('careerIdealUserId');
        
        // 如果没有userId，生成一个新的唯一标识
        if (!userId) {
            userId = generateUUID();
            localStorage.setItem('careerIdealUserId', userId);
        }

        // 生成UUID用于匿名用户标识
        function generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0;
                const v = c === 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }

        // 检查是否已提交
        function checkSubmitted() {
            const userQuery = new AV.Query(CareerIdealWord);
            userQuery.equalTo('userId', userId);
            return userQuery.count().then(count => {
                hasSubmitted = count > 0;
                if (hasSubmitted) {
                    idealInput.disabled = true;
                    submitBtn.disabled = true;
                    submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    showMessage('你已经提交过职业理想啦！', 'text-secondary');
                }
                return hasSubmitted;
            });
        }

        // 显示消息提示
        function showMessage(text, className = 'text-red-500') {
            message.textContent = text;
            message.className = `mt-3 text-sm ${className}`;
            message.classList.remove('hidden');
            
            // 3秒后隐藏消息
            setTimeout(() => {
                message.classList.add('hidden');
            }, 3000);
        }

        // 提交职业理想
        function submitIdeal() {
            const word = idealInput.value.trim();
            
            if (!word) {
                showMessage('请输入你的职业理想');
                return;
            }
            
            if (word.length > 10) {
                showMessage('请输入不超过10个字符的词语');
                return;
            }
            
            // 创建新的记录
            const careerIdeal = new CareerIdealWord();
            careerIdeal.set('word', word);
            careerIdeal.set('userId', userId);
            careerIdeal.set('timestamp', new Date());
            
            careerIdeal.save().then(() => {
                showMessage('提交成功！感谢你的分享', 'text-secondary');
                idealInput.value = '';
                idealInput.disabled = true;
                submitBtn.disabled = true;
                submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                hasSubmitted = true;
                
                // 添加到弹幕
                addDanmaku(word);
                // 立即更新词云
                getAllWords().then(words => generateWordCloud(words));
            }).catch(error => {
                showMessage('提交失败，请稍后再试');
                console.error('提交失败:', error);
            });
        }

        // 添加弹幕
        function addDanmaku(text) {
            const danmaku = document.createElement('div');
            danmaku.className = 'absolute whitespace-nowrap font-medium transition-opacity duration-500';
            
            // 随机样式
            const fontSize = 14 + Math.random() * 8;
            const colors = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899', '#6366F1'];
            const color = colors[Math.floor(Math.random() * colors.length)];
            const top = Math.random() * (danmakuArea.clientHeight - 30);
            
            danmaku.style.fontSize = `${fontSize}px`;
            danmaku.style.color = color;
            danmaku.style.top = `${top}px`;
            danmaku.style.right = `-${text.length * fontSize}px`;
            danmaku.textContent = text;
            danmaku.style.opacity = '0';
            
            danmakuArea.appendChild(danmaku);
            
            // 延迟显示，创建渐入效果
            setTimeout(() => {
                danmaku.style.opacity = '1';
            }, 100);
            
            // 动画
            const duration = 8000 + Math.random() * 5000;
            let start = null;
            
            function animate(timestamp) {
                if (!start) start = timestamp;
                const progress = timestamp - start;
                const distance = danmakuArea.clientWidth + text.length * fontSize;
                const position = -progress / duration * distance;
                
                danmaku.style.right = `${position}px`;
                
                if (progress < duration) {
                    requestAnimationFrame(animate);
                } else {
                    // 淡出效果
                    danmaku.style.opacity = '0';
                    setTimeout(() => {
                        danmaku.remove();
                    }, 500);
                }
            }
            
            requestAnimationFrame(animate);
        }

        // 生成词云
        function generateWordCloud(words) {
            if (words.length === 0) {
                emptyState.classList.remove('hidden');
                return;
            }
            
            emptyState.classList.add('hidden');
            
            // 处理数据格式
            const wordList = words.map(item => [item.word, item.count]);
            
            // 清除画布
            const ctx = wordcloudCanvas.getContext('2d');
            ctx.clearRect(0, 0, wordcloudCanvas.width, wordcloudCanvas.height);
            
            // 设置画布尺寸以匹配显示大小
            wordcloudCanvas.width = wordcloudCanvas.offsetWidth;
            wordcloudCanvas.height = wordcloudCanvas.offsetHeight;
            
            // 生成词云
            WordCloud(wordcloudCanvas, {
                list: wordList,
                backgroundColor: '#fff',
                color: function(random) {
                    const colors = [
                        '#3b82f6', '#10b981', '#f59e0b', '#ef4444', 
                        '#8b5cf6', '#ec4899', '#6366f1', '#14b8a6'
                    ];
                    return colors[Math.floor(random * colors.length)];
                },
                rotationSteps: 2,
                minSize: 12,
                maxSize: 60,
                gridSize: 8,
                fontFamily: 'system-ui, sans-serif',
                shuffle: true
            });
        }

        // 获取所有词语并计算频率
        function getAllWords() {
            return query.find().then(results => {
                const wordMap = {};
                
                results.forEach(item => {
                    const word = item.get('word');
                    if (wordMap[word]) {
                        wordMap[word]++;
                    } else {
                        wordMap[word] = 1;
                    }
                });
                
                // 转换为数组并按频率排序
                return Object.keys(wordMap).map(word => ({
                    word,
                    count: wordMap[word]
                })).sort((a, b) => b.count - a.count);
            });
        }

        // 初始化页面
        function init() {
            // 检查是否已提交
            checkSubmitted();
            
            // 加载已有词语并生成词云
            getAllWords().then(words => {
                generateWordCloud(words);
                
                // 随机显示一些已有弹幕
                if (words.length > 0) {
                    words.forEach(word => {
                        // 随机决定是否显示这个词的弹幕
                        if (Math.random() > 0.7) {
                            // 随机显示1到count次，但不超过3次
                            const times = Math.ceil(Math.random() * Math.min(word.count, 3));
                            for (let i = 0; i < times; i++) {
                                setTimeout(() => {
                                    addDanmaku(word.word);
                                }, Math.random() * 5000);
                            }
                        }
                    });
                }
            });
            
            // 设置实时更新
            setInterval(() => {
                getAllWords().then(words => {
                    generateWordCloud(words);
                    
                    // 随机添加新弹幕
                    if (words.length > 0 && Math.random() > 0.5) {
                        const randomWord = words[Math.floor(Math.random() * words.length)];
                        addDanmaku(randomWord.word);
                    }
                });
            }, 8000); // 每8秒更新一次
        }

        // 事件监听
        submitBtn.addEventListener('click', submitIdeal);
        idealInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                submitIdeal();
            }
        });

        // 窗口大小变化时重新绘制词云
        window.addEventListener('resize', () => {
            getAllWords().then(words => {
                generateWordCloud(words);
            });
        });

        // 初始化应用
        init();
    </script>
</body>
</html>
