<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>职业理想热门词统计</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入Chart.js用于生成柱形图 -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <!-- 引入LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.0/dist/av-min.js"></script>
    <!-- 引入LiveQuery扩展 -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-live-query@3.1.0/dist/av-live-query.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#8B5CF6',
                        dark: '#1E293B',
                        light: '#F8FAFC'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .弹幕容器 {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 50;
                overflow: hidden;
            }
            .弹幕 {
                position: absolute;
                white-space: nowrap;
                animation: 弹幕动画 8s linear forwards;
                opacity: 0.85;
                text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            }
            @keyframes 弹幕动画 {
                from { transform: translateX(100vw); }
                to { transform: translateX(-100%); }
            }
            .chart-container {
                position: relative;
                width: 100%;
                height: 100%;
                min-height: 400px;
            }
            .error-notice {
                position: fixed;
                bottom: 20px;
                left: 50%;
                transform: translateX(-50%);
                background-color: #EF4444;
                color: white;
                padding: 10px 20px;
                border-radius: 5px;
                z-index: 100;
                max-width: 90%;
                text-align: center;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-light to-blue-50 min-h-screen">
    <!-- 错误提示（默认隐藏） -->
    <div id="错误提示" class="error-notice hidden"></div>

    <!-- 顶部导航 -->
    <header class="bg-white/80 backdrop-blur-md shadow-sm fixed top-0 left-0 right-0 z-40 transition-all duration-300">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-bar-chart text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold text-dark">职业理想热门词</h1>
            </div>
            <div class="text-sm text-gray-600" id="参与人数">
                <i class="fa fa-users mr-1"></i>
                <span>参与人数: 0</span>
            </div>
        </div>
    </header>

    <!-- 主要内容区 -->
    <main class="container mx-auto px-4 pt-20 pb-16">
        <!-- 柱形图展示区 -->
        <section class="mt-6 mb-8 rounded-xl bg-white shadow-lg p-4 md:p-6 relative overflow-hidden">
            <h2 class="text-lg md:text-xl font-semibold mb-4 text-dark flex items-center">
                <i class="fa fa-list text-accent mr-2"></i>班级职业理想热门词统计
            </h2>
            <div class="chart-container border rounded-lg bg-gray-50" id="图表容器">
                <canvas id="统计图表" class="w-full h-full"></canvas>
                <div id="图表加载状态" class="absolute inset-0 flex items-center justify-center bg-white/80 z-10">
                    <div class="text-center">
                        <i class="fa fa-circle-o-notch fa-spin text-primary text-3xl mb-2"></i>
                        <p class="text-gray-600">加载统计数据中...</p>
                    </div>
                </div>
            </div>
        </section>

        <!-- 输入区 -->
        <section class="max-w-md mx-auto bg-white rounded-xl shadow-lg p-6 mb-8 transform transition-all hover:shadow-xl">
            <h2 class="text-lg md:text-xl font-semibold mb-4 text-dark flex items-center">
                <i class="fa fa-pencil text-secondary mr-2"></i>分享你的职业理想
            </h2>
            <p class="text-gray-600 text-sm mb-4">请输入一个词来代表你的职业理想，例如"自由"、"创新"等</p>
            <form id="理想表单" class="space-y-4">
                <div>
                    <input type="text" id="理想输入" 
                        class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all outline-none"
                        placeholder="输入你的职业理想..." maxlength="10" required>
                </div>
                <button type="submit" id="提交按钮" 
                    class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-2 px-4 rounded-lg transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center">
                    <i class="fa fa-paper-plane mr-2"></i>提交
                </button>
                <p id="提交状态" class="text-center text-sm hidden"></p>
            </form>
        </section>

        <!-- 说明区 -->
        <section class="bg-white/70 backdrop-blur-sm rounded-xl p-4 md:p-6 shadow">
            <h3 class="font-semibold text-dark mb-2 flex items-center">
                <i class="fa fa-info-circle text-accent mr-2"></i>系统说明
            </h3>
            <ul class="text-gray-600 text-sm space-y-1 list-disc pl-5">
                <li>每个用户只能提交一次职业理想</li>
                <li>提交后会实时更新统计图表并显示在弹幕中</li>
                <li>柱形图高度代表词语出现的频率</li>
                <li>所有设备会实时同步更新结果</li>
            </ul>
        </section>
    </main>

    <!-- 弹幕容器 -->
    <div class="弹幕容器" id="弹幕容器"></div>

    <!-- 页脚 -->
    <footer class="bg-dark text-white/70 text-sm py-4 mt-auto">
        <div class="container mx-auto px-4 text-center">
            <p>职业理想热门词统计系统 &copy; 2023</p>
        </div>
    </footer>

    <script>
        // 初始化LeanCloud
        AV.init({
            appId: "uJ3KsasvmBzf9Xn2OodGclFx-gzGzoHsz",
            appKey: "JEsdiH1q5v1NzqyLCLqJVWvt",
            serverURLs: "https://uj3ksasv.lc-cn-n1-shared.com"
        });

        // 获取CareerIdealWord类
        const CareerIdealWord = AV.Object.extend('CareerIdealWord');
        const query = new AV.Query(CareerIdealWord);
        
        // DOM元素
        const 理想表单 = document.getElementById('理想表单');
        const 理想输入 = document.getElementById('理想输入');
        const 提交按钮 = document.getElementById('提交按钮');
        const 提交状态 = document.getElementById('提交状态');
        const 图表容器 = document.getElementById('图表容器');
        const 统计图表 = document.getElementById('统计图表');
        const 图表加载状态 = document.getElementById('图表加载状态');
        const 弹幕容器 = document.getElementById('弹幕容器');
        const 参与人数显示 = document.querySelector('#参与人数 span');
        const 错误提示 = document.getElementById('错误提示');
        
        // 图表实例
        let 图表实例 = null;
        
        // 检查用户是否已提交过
        let 已提交 = localStorage.getItem('careerIdealSubmitted') === 'true';
        let 词语数据 = {};
        let 所有词语 = [];
        let 实时查询实例 = null;
        
        // 显示错误信息
        function 显示错误信息(消息) {
            错误提示.textContent = 消息;
            错误提示.classList.remove('hidden');
            
            // 5秒后自动隐藏
            setTimeout(() => {
                错误提示.classList.add('hidden');
            }, 5000);
        }
        
        // 初始化页面状态
        if (已提交) {
            理想输入.disabled = true;
            提交按钮.disabled = true;
            提交按钮.classList.add('bg-gray-400', 'hover:bg-gray-400');
            提交按钮.classList.remove('bg-primary', 'hover:bg-primary/90');
            提交状态.textContent = '你已提交过职业理想，感谢参与！';
            提交状态.classList.remove('hidden', 'text-red-500');
            提交状态.classList.add('text-green-500');
        }
        
        // 生成随机颜色
        function 生成随机颜色() {
            const colors = [
                '#3B82F6', '#10B981', '#8B5CF6', '#EF4444', '#F59E0B',
                '#EC4899', '#14B8A6', '#6366F1', '#F97316', '#84CC16'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // 添加弹幕
        function 添加弹幕(文本) {
            const 弹幕 = document.createElement('div');
            弹幕.className = '弹幕';
            弹幕.textContent = 文本;
            
            // 随机样式
            弹幕.style.color = 生成随机颜色();
            弹幕.style.fontSize = `${14 + Math.random() * 16}px`;
            弹幕.style.top = `${Math.random() * 80 + 10}%`;
            弹幕.style.animationDuration = `${6 + Math.random() * 8}s`;
            
            弹幕容器.appendChild(弹幕);
            
            // 动画结束后移除
            setTimeout(() => {
                弹幕.remove();
            }, 15000);
        }
        
        // 随机展示已有弹幕
        function 随机展示弹幕() {
            if (所有词语.length > 0) {
                const 随机索引 = Math.floor(Math.random() * 所有词语.length);
                添加弹幕(所有词语[随机索引]);
            }
            setTimeout(随机展示弹幕, 3000 + Math.random() * 5000);
        }
        
        // 生成柱形图
        function 生成柱形图(数据) {
            // 准备图表数据：按出现次数排序，只显示前10个热门词
            const 排序后的词语 = Object.entries(数据)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
                
            const 词语列表 = 排序后的词语.map(item => item[0]);
            const 次数列表 = 排序后的词语.map(item => item[1]);
            const 背景颜色 = 词语列表.map(() => 生成随机颜色().replace('rgb', 'rgba').replace(')', ', 0.7)'));
            const 边框颜色 = 词语列表.map(() => 生成随机颜色());
            
            // 如果已有图表实例，先销毁
            if (图表实例) {
                图表实例.destroy();
            }
            
            // 设置画布尺寸
            function 设置画布尺寸() {
                const { width, height } = 图表容器.getBoundingClientRect();
                统计图表.width = width;
                统计图表.height = height;
            }
            
            设置画布尺寸();
            window.addEventListener('resize', 设置画布尺寸);
            
            // 创建新图表
            图表实例 = new Chart(统计图表, {
                type: 'bar',
                data: {
                    labels: 词语列表,
                    datasets: [{
                        label: '出现次数',
                        data: 次数列表,
                        backgroundColor: 背景颜色,
                        borderColor: 边框颜色,
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0 // 确保Y轴只显示整数
                            },
                            title: {
                                display: true,
                                text: '出现次数'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '职业理想词汇'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `出现次数: ${context.raw}`;
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeOutQuart'
                    }
                }
            });
            
            图表加载状态.classList.add('hidden');
        }
        
        // 更新词语数据
        function 更新词语数据(新词语) {
            if (新词语) {
                词语数据[新词语] = (词语数据[新词语] || 0) + 1;
                所有词语.push(新词语);
                添加弹幕(新词语);
            }
            
            // 更新参与人数
            const 参与人数 = Object.values(词语数据).reduce((total, count) => total + count, 0);
            参与人数显示.textContent = `参与人数: ${参与人数}`;
            
            // 生成柱形图
            生成柱形图(词语数据);
        }
        
        // 定时刷新数据（替代LiveQuery的方案）
        function 定时刷新数据() {
            query.find().then(results => {
                const 新词语数据 = {};
                const 新所有词语 = [];
                
                results.forEach(result => {
                    const 词语 = result.get('word');
                    if (词语) {
                        新词语数据[词语] = (新词语数据[词语] || 0) + 1;
                        新所有词语.push(词语);
                    }
                });
                
                // 检查是否有新数据
                const 旧数据量 = Object.values(词语数据).reduce((total, count) => total + count, 0);
                const 新数据量 = Object.values(新词语数据).reduce((total, count) => total + count, 0);
                
                if (新数据量 > 旧数据量) {
                    词语数据 = 新词语数据;
                    所有词语 = 新所有词语;
                    生成柱形图(词语数据);
                }
            }).catch(error => {
                console.error('刷新数据失败:', error);
            });
            
            // 每10秒刷新一次
            setTimeout(定时刷新数据, 10000);
        }
        
        // 从LeanCloud获取所有数据
        function 获取所有数据() {
            图表加载状态.innerHTML = '<i class="fa fa-circle-o-notch fa-spin text-primary text-3xl mb-2"></i><p class="text-gray-600">加载统计数据中...</p>';
            
            query.find().then(results => {
                词语数据 = {};
                所有词语 = [];
                
                results.forEach(result => {
                    const 词语 = result.get('word');
                    if (词语) {
                        词语数据[词语] = (词语数据[词语] || 0) + 1;
                        所有词语.push(词语);
                    }
                });
                
                更新词语数据();
            }).catch(error => {
                console.error('获取数据失败:', error);
                图表加载状态.innerHTML = `<p class="text-red-500">获取数据失败: ${error.message}</p>`;
                显示错误信息('获取数据失败，请检查网络连接');
            });
        }
        
        // 提交新的职业理想
        理想表单.addEventListener('submit', function(e) {
            e.preventDefault();
            
            if (已提交) return;
            
            const 词语 = 理想输入.value.trim();
            if (!词语) return;
            
            提交按钮.disabled = true;
            提交按钮.innerHTML = '<i class="fa fa-circle-o-notch fa-spin mr-2"></i>提交中...';
            
            // 保存到LeanCloud
            const 新词语 = new CareerIdealWord();
            新词语.set('word', 词语);
            
            新词语.save().then(() => {
                // 标记为已提交
                已提交 = true;
                localStorage.setItem('careerIdealSubmitted', 'true');
                
                提交状态.textContent = '提交成功！感谢你的参与！';
                提交状态.classList.remove('hidden', 'text-red-500');
                提交状态.classList.add('text-green-500');
                
                理想输入.disabled = true;
                提交按钮.innerHTML = '<i class="fa fa-check mr-2"></i>已提交';
                提交按钮.classList.add('bg-gray-400', 'hover:bg-gray-400');
                提交按钮.classList.remove('bg-primary', 'hover:bg-primary/90');
                
                // 立即刷新数据
                获取所有数据();
            }).catch(error => {
                console.error('提交失败:', error);
                提交状态.textContent = `提交失败: ${error.message}`;
                提交状态.classList.remove('hidden', 'text-green-500');
                提交状态.classList.add('text-red-500');
                
                提交按钮.disabled = false;
                提交按钮.innerHTML = '<i class="fa fa-paper-plane mr-2"></i>提交';
                显示错误信息('提交失败: ' + error.message);
            });
        });
        
        // 尝试初始化LiveQuery
        function 初始化LiveQuery() {
            try {
                // 检查LiveQuery是否可用
                if (typeof AV.LiveQuery === 'undefined') {
                    throw new Error('LiveQuery未加载');
                }
                
                const 实时查询 = new AV.Query(CareerIdealWord);
                实时查询实例 = AV.LiveQuery.subscribe(实时查询);
                
                实时查询实例.on('create', (object) => {
                    const 新词语 = object.get('word');
                    if (新词语) {
                        更新词语数据(新词语);
                    }
                });
                
                console.log('LiveQuery初始化成功');
            } catch (error) {
                console.error('LiveQuery初始化失败:', error);
                显示错误信息('实时更新功能不可用，将使用定时刷新模式。请在LeanCloud控制台启用LiveQuery以获得最佳体验。');
                // 退回到定时刷新模式
                定时刷新数据();
            }
        }
        
        // 初始化系统
        function 初始化() {
            获取所有数据();
            初始化LiveQuery();
            随机展示弹幕();
            
            // 窗口 resize 时重绘图表
            window.addEventListener('resize', () => {
                if (Object.keys(词语数据).length > 0) {
                    生成柱形图(词语数据);
                }
            });
        }
        
        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', 初始化);
    </script>
</body>
</html>
