<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>职业理想词云</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.0/dist/av-min.js"></script>
    <!-- 引入词云库 -->
    <script src="https://cdn.jsdelivr.net/npm/wordcloud2.js@1.2.1/src/wordcloud2.min.js"></script>
    
    <!-- Tailwind配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#8B5CF6',
                        dark: '#1F2937',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .wordcloud-container {
                position: relative;
                overflow: hidden;
            }
            .danmaku {
                position: absolute;
                white-space: nowrap;
                pointer-events: none;
                z-index: 10;
                animation: danmaku 8s linear forwards;
            }
            @keyframes danmaku {
                from { transform: translateX(100vw); }
                to { transform: translateX(-100%); }
            }
            .fade-in {
                animation: fadeIn 0.5s ease-in-out;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen">
    <!-- 弹幕容器 -->
    <div id="danmakuContainer" class="fixed top-0 left-0 w-full h-full pointer-events-none z-30"></div>
    
    <div class="container mx-auto px-4 py-8 max-w-5xl relative z-40">
        <!-- 标题区域 -->
        <header class="text-center mb-8 fade-in">
            <h1 class="text-[clamp(2rem,5vw,3.5rem)] font-bold text-dark mb-2 text-shadow">
                <i class="fa fa-lightbulb-o text-yellow-500 mr-2"></i>职业理想词云
            </h1>
            <p class="text-gray-600 text-[clamp(1rem,2vw,1.2rem)] max-w-2xl mx-auto">
                输入一个词来描述你的职业理想，共同创建我们班级的职业理想词云
            </p>
        </header>
        
        <!-- 输入区域 -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 fade-in" style="animation-delay: 0.2s">
            <form id="wordForm" class="flex flex-col md:flex-row gap-4">
                <input 
                    type="text" 
                    id="wordInput" 
                    placeholder="例如：自由、创新、稳定..." 
                    class="flex-1 px-4 py-3 rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all"
                    maxlength="10"
                    required
                >
                <button 
                    type="submit" 
                    id="submitBtn"
                    class="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg font-medium transition-all transform hover:scale-105 active:scale-95 flex items-center justify-center gap-2"
                >
                    <i class="fa fa-paper-plane"></i>
                    <span>提交理想</span>
                </button>
            </form>
            <p id="statusMessage" class="mt-3 text-sm text-gray-500 hidden"></p>
        </div>
        
        <!-- 词云展示区域 -->
        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-8 wordcloud-container fade-in" style="animation-delay: 0.4s">
            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                <i class="fa fa-cloud text-primary mr-2"></i>班级职业理想词云
            </h2>
            <div id="wordcloud" class="w-full h-[clamp(200px,50vw,400px)] rounded-lg overflow-hidden border border-gray-100 bg-gray-50"></div>
        </div>
        
        <!-- 统计信息 -->
        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 text-center fade-in" style="animation-delay: 0.6s">
            <div class="flex flex-wrap justify-center gap-6">
                <div>
                    <p class="text-gray-500 text-sm">参与人数</p>
                    <p id="participantCount" class="text-2xl font-bold text-primary">0</p>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">总词汇数</p>
                    <p id="totalWordsCount" class="text-2xl font-bold text-secondary">0</p>
                </div>
                <div>
                    <p class="text-gray-500 text-sm">独特词汇</p>
                    <p id="uniqueWordsCount" class="text-2xl font-bold text-accent">0</p>
                </div>
            </div>
        </div>
        
        <!-- 页脚 -->
        <footer class="mt-12 text-center text-gray-500 text-sm">
            <p>职业理想词云系统 &copy; 2023</p>
        </footer>
    </div>

    <script>
        // 初始化LeanCloud
        AV.init({
            appId: "uJ3KsasvmBzf9Xn2OodGclFx-gzGzoHsz",
            appKey: "JEsdiH1q5v1NzqyLCLqJVWvt",
            serverURLs: "https://uj3ksasv.lc-cn-n1-shared.com"
        });
        
        // 获取CareerIdealWord类
        const CareerIdealWord = AV.Object.extend('CareerIdealWord');
        const query = new AV.Query(CareerIdealWord);
        
        // DOM元素
        const wordForm = document.getElementById('wordForm');
        const wordInput = document.getElementById('wordInput');
        const submitBtn = document.getElementById('submitBtn');
        const statusMessage = document.getElementById('statusMessage');
        const wordcloud = document.getElementById('wordcloud');
        const danmakuContainer = document.getElementById('danmakuContainer');
        const participantCount = document.getElementById('participantCount');
        const totalWordsCount = document.getElementById('totalWordsCount');
        const uniqueWordsCount = document.getElementById('uniqueWordsCount');
        
        // 存储所有词语和统计数据
        let allWords = [];
        let wordFrequency = {};
        let wordList = [];
        
        // 检查用户是否已提交
        const hasSubmitted = localStorage.getItem('careerIdealSubmitted') === 'true';
        if (hasSubmitted) {
            wordInput.disabled = true;
            submitBtn.disabled = true;
            submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
            submitBtn.classList.remove('bg-primary', 'hover:bg-primary/90', 'hover:scale-105', 'active:scale-95');
            showMessage('你已提交过职业理想，感谢参与！', 'info');
        }
        
        // 提交词语
        wordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const word = wordInput.value.trim();
            if (!word) return;
            
            try {
                // 禁用按钮防止重复提交
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i> 提交中...';
                
                // 创建新记录
                const careerIdeal = new CareerIdealWord();
                careerIdeal.set('word', word);
                await careerIdeal.save();
                
                // 标记为已提交
                localStorage.setItem('careerIdealSubmitted', 'true');
                
                // 显示成功消息
                showMessage(`成功提交："${word}"，感谢你的参与！`, 'success');
                
                // 禁用输入
                wordInput.disabled = true;
                submitBtn.innerHTML = '<i class="fa fa-check"></i> 已提交';
                submitBtn.classList.add('bg-green-500');
                submitBtn.classList.remove('bg-primary');
                
                // 立即显示为弹幕
                addDanmaku(word);
                
            } catch (error) {
                console.error('提交失败:', error);
                showMessage('提交失败，请稍后再试', 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa fa-paper-plane"></i> 提交理想';
            }
        });
        
        // 显示消息
        function showMessage(text, type = 'info') {
            statusMessage.textContent = text;
            statusMessage.classList.remove('hidden', 'text-green-600', 'text-red-600', 'text-blue-600');
            
            switch(type) {
                case 'success':
                    statusMessage.classList.add('text-green-600');
                    break;
                case 'error':
                    statusMessage.classList.add('text-red-600');
                    break;
                default:
                    statusMessage.classList.add('text-blue-600');
            }
            
            // 3秒后隐藏消息（除了已提交状态）
            if (type !== 'info') {
                setTimeout(() => {
                    statusMessage.classList.add('hidden');
                }, 3000);
            }
        }
        
        // 添加弹幕
        function addDanmaku(text) {
            const danmaku = document.createElement('div');
            danmaku.className = 'danmaku';
            danmaku.textContent = text;
            
            // 随机样式
            const size = Math.random() * 16 + 14; // 14-30px
            const color = getRandomColor();
            const top = Math.random() * (window.innerHeight - 100); // 避免超出屏幕
            
            danmaku.style.fontSize = `${size}px`;
            danmaku.style.color = color;
            danmaku.style.top = `${top}px`;
            danmaku.style.opacity = Math.random() * 0.5 + 0.5; // 0.5-1.0
            danmaku.style.animationDuration = `${Math.random() * 6 + 6}s`; // 6-12秒
            
            danmakuContainer.appendChild(danmaku);
            
            // 动画结束后移除元素
            setTimeout(() => {
                danmaku.remove();
            }, parseFloat(danmaku.style.animationDuration) * 1000);
        }
        
        // 随机颜色
        function getRandomColor() {
            const colors = [
                '#3B82F6', '#10B981', '#8B5CF6', '#EF4444', '#F59E0B',
                '#EC4899', '#14B8A6', '#6366F1', '#F97316', '#84CC16'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // 定期随机显示已有弹幕
        function scheduleRandomDanmakus() {
            if (allWords.length > 0) {
                const randomWord = allWords[Math.floor(Math.random() * allWords.length)];
                addDanmaku(randomWord);
            }
            
            // 随机间隔1-5秒
            const interval = Math.random() * 4000 + 1000;
            setTimeout(scheduleRandomDanmakus, interval);
        }
        
        // 更新词云 - 修复版本
        function updateWordCloud() {
            console.log("更新词云，当前词频数据:", wordFrequency);
            
            // 清空现有词云
            wordcloud.innerHTML = '';
            
            // 准备词云数据 - 转换为wordcloud2.js所需的格式 [[word, weight], ...]
            wordList = Object.entries(wordFrequency).map(([word, count]) => [
                word, 
                count + Math.log(count + 1) * 5 // 调整权重使差异更明显
            ]);
            
            console.log("词云数据列表:", wordList);
            
            // 生成词云
            if (wordList.length > 0) {
                // 确保容器有正确的尺寸
                const containerWidth = wordcloud.offsetWidth;
                const containerHeight = wordcloud.offsetHeight;
                console.log(`词云容器尺寸: ${containerWidth}x${containerHeight}`);
                
                // 配置词云参数
                const options = {
                    list: wordList,
                    fontFamily: 'sans-serif',
                    color: () => getRandomColor(),
                    rotate: () => (Math.random() > 0.7 ? (Math.random() > 0.5 ? 90 : -90) : 0),
                    backgroundColor: 'transparent',
                    weightFactor: 10,
                    minSize: 10,
                    gridSize: 8,
                    drawOutOfBound: false,
                    shuffle: true
                };
                
                console.log("词云配置:", options);
                
                // 生成词云
                try {
                    WordCloud(wordcloud, options);
                    console.log("词云生成成功");
                } catch (error) {
                    console.error("词云生成失败:", error);
                    wordcloud.innerHTML = '<div class="w-full h-full flex items-center justify-center text-red-500">词云生成失败，请刷新页面</div>';
                }
            } else {
                // 没有数据时显示提示
                wordcloud.innerHTML = '<div class="w-full h-full flex items-center justify-center text-gray-400">等待大家的职业理想...</div>';
                console.log("没有词云数据可显示");
            }
            
            // 更新统计数据
            participantCount.textContent = allWords.length;
            totalWordsCount.textContent = allWords.length;
            uniqueWordsCount.textContent = Object.keys(wordFrequency).length;
        }
        
        // 加载所有词语
        async function loadAllWords() {
            try {
                showMessage('正在加载职业理想数据...', 'info');
                
                // 查询所有记录，按创建时间排序
                query.ascending('createdAt');
                const results = await query.find();
                
                console.log(`加载到${results.length}条数据`);
                
                // 提取词语
                allWords = results.map(result => result.get('word'));
                
                // 计算词频
                wordFrequency = {};
                allWords.forEach(word => {
                    wordFrequency[word] = (wordFrequency[word] || 0) + 1;
                });
                
                showMessage(`成功加载${allWords.length}条职业理想数据`, 'success');
                
                // 更新词云
                updateWordCloud();
                
                // 随机显示一些已有弹幕
                if (allWords.length > 0) {
                    // 初始显示3-5个弹幕
                    const initialCount = Math.min(Math.floor(Math.random() * 3) + 3, allWords.length);
                    for (let i = 0; i < initialCount; i++) {
                        setTimeout(() => {
                            const randomWord = allWords[Math.floor(Math.random() * allWords.length)];
                            addDanmaku(randomWord);
                        }, i * 1000);
                    }
                }
                
            } catch (error) {
                console.error('加载数据失败:', error);
                showMessage('加载数据失败，请刷新页面重试', 'error');
            }
        }
        
        // 监听数据变化
        function watchForChanges() {
            try {
                const liveQuery = query.subscribe();
                
                liveQuery.on('create', (object) => {
                    const newWord = object.get('word');
                    console.log(`收到新词语: ${newWord}`);
                    allWords.push(newWord);
                    wordFrequency[newWord] = (wordFrequency[newWord] || 0) + 1;
                    updateWordCloud();
                    addDanmaku(newWord);
                });
                
                liveQuery.on('error', (error) => {
                    console.error('实时查询错误:', error);
                    showMessage('实时更新连接断开，数据可能无法同步', 'error');
                });
                
                console.log('实时查询已启动');
            } catch (error) {
                console.error('启动实时查询失败:', error);
                showMessage('无法建立实时连接，可能无法看到最新数据', 'error');
            }
        }
        
        // 初始化 - 确保DOM完全加载后执行
        document.addEventListener('DOMContentLoaded', () => {
            console.log('页面加载完成，开始初始化');
            
            // 确保词云容器已准备好
            if (wordcloud) {
                console.log('词云容器已找到');
                loadAllWords();
                watchForChanges();
                scheduleRandomDanmakus();
                
                // 窗口大小变化时重新绘制词云
                window.addEventListener('resize', () => {
                    if (wordList.length > 0) {
                        updateWordCloud();
                    }
                });
            } else {
                console.error('未找到词云容器');
                alert('页面加载错误，未找到词云显示区域');
            }
        });
    </script>
</body>
</html>
