<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>职业理想词云</title>
    <!-- 引入Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入Font Awesome -->
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <!-- 引入WordCloud库 -->
    <script src="https://cdn.jsdelivr.net/npm/wordcloud2.js@1.2.1/src/wordcloud2.min.js"></script>
    
    <!-- 配置Tailwind自定义颜色 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#8B5CF6',
                        dark: '#1F2937',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .弹幕容器 {
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                pointer-events: none;
                z-index: 50;
                overflow: hidden;
            }
            .弹幕元素 {
                position: absolute;
                white-space: nowrap;
                animation: 弹幕动画 linear forwards;
            }
            @keyframes 弹幕动画 {
                from { transform: translateX(100vw); }
                to { transform: translateX(-100%); }
            }
            .词云容器 {
                position: relative;
                width: 100%;
                height: 400px;
                max-width: 800px;
                margin: 0 auto;
            }
            @media (max-width: 640px) {
                .词云容器 {
                    height: 300px;
                }
            }
            .debug-info {
                position: fixed;
                bottom: 10px;
                left: 10px;
                background: rgba(0,0,0,0.7);
                color: white;
                padding: 5px 10px;
                border-radius: 4px;
                font-size: 12px;
                z-index: 100;
                max-width: 300px;
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen font-sans">
    <div class="container mx-auto px-4 py-8 max-w-5xl">
        <!-- 页面标题 -->
        <header class="text-center mb-8">
            <h1 class="text-[clamp(2rem,5vw,3rem)] font-bold text-dark mb-2">
                <i class="fa fa-cloud text-primary mr-2"></i>职业理想词云
            </h1>
            <p class="text-gray-600 text-lg">分享你的职业理想，共同描绘班级愿景</p>
        </header>
        
        <!-- 输入区域 -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-8 transform transition-all duration-300 hover:shadow-xl">
            <div class="flex flex-col md:flex-row gap-4">
                <input 
                    type="text" 
                    id="理想输入" 
                    placeholder="输入一个词描述你的职业理想，例如：创新、自由..." 
                    class="flex-1 px-4 py-3 rounded-lg border border-gray-300 focus:border-primary focus:ring-2 focus:ring-primary/20 outline-none transition-all"
                    maxlength="10"
                >
                <button 
                    id="提交按钮" 
                    class="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg font-medium transition-all transform hover:scale-105 active:scale-95 flex items-center justify-center gap-2"
                >
                    <i class="fa fa-paper-plane"></i>
                    <span>提交理想</span>
                </button>
            </div>
            <p id="状态提示" class="mt-3 text-sm text-gray-500 hidden"></p>
        </div>
        
        <!-- 词云区域 -->
        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 mb-8">
            <h2 class="text-xl font-semibold text-dark mb-4 flex items-center">
                <i class="fa fa-tags text-accent mr-2"></i>班级职业理想词云
            </h2>
            <div class="词云容器 bg-gray-50 rounded-lg">
                <canvas id="词云画布"></canvas>
                <div id="词云加载中" class="absolute inset-0 flex items-center justify-center bg-white/80 z-10">
                    <div class="text-center">
                        <div class="inline-block animate-spin rounded-full h-8 w-8 border-b-2 border-primary mb-2"></div>
                        <p class="text-gray-600">加载词云数据中...</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 说明区域 -->
        <div class="bg-white rounded-xl shadow-lg p-6 text-gray-600 text-sm">
            <h3 class="font-semibold text-dark mb-2 flex items-center">
                <i class="fa fa-info-circle text-secondary mr-2"></i>使用说明
            </h3>
            <ul class="list-disc pl-5 space-y-1">
                <li>每个同学可以提交一个代表自己职业理想的词语</li>
                <li>提交后会实时显示在词云中，出现次数越多的词语显示越大</li>
                <li>所有提交的理想会以弹幕形式滚动展示</li>
                <li>页面会自动适配手机和电脑等不同设备</li>
            </ul>
        </div>
        
        <!-- 页脚 -->
        <footer class="mt-12 text-center text-gray-500 text-sm">
            <p>职业理想词云系统 &copy; 2023</p>
        </footer>
    </div>
    
    <!-- 弹幕容器 -->
    <div class="弹幕容器" id="弹幕容器"></div>

    <!-- 调试信息 (生产环境可隐藏) -->
    <div class="debug-info hidden" id="调试信息">
        状态: 初始化中...
    </div>

    <script>
        // 初始化LeanCloud - 关键修复：确保服务器地址正确
        AV.init({
            appId: "uJ3KsasvmBzf9Xn2OodGclFx-gzGzoHsz",
            appKey: "JEsdiH1q5v1NzqyLCLqJVWvt",
            serverURLs: "https://uj3ksasv.lc-cn-n1-shared.com" // 根据AppID确认的正确服务器地址
        });
        
        // 验证LeanCloud初始化状态
        function 验证LeanCloud初始化() {
            try {
                if (AV.applicationId && AV.applicationKey) {
                    显示调试信息(`LeanCloud初始化成功: ${AV.applicationId}`);
                    return true;
                } else {
                    显示调试信息("LeanCloud初始化失败: 缺少AppID或AppKey");
                    return false;
                }
            } catch (e) {
                显示调试信息(`LeanCloud初始化错误: ${e.message}`);
                return false;
            }
        }
        
        // 获取CareerIdealWord类
        const CareerIdealWord = AV.Object.extend('CareerIdealWord');
        const query = new AV.Query(CareerIdealWord);
        
        // DOM元素
        const 理想输入 = document.getElementById('理想输入');
        const 提交按钮 = document.getElementById('提交按钮');
        const 状态提示 = document.getElementById('状态提示');
        const 词云画布 = document.getElementById('词云画布');
        const 词云容器 = document.querySelector('.词云容器');
        const 词云加载中 = document.getElementById('词云加载中');
        const 弹幕容器 = document.getElementById('弹幕容器');
        const 调试信息 = document.getElementById('调试信息');
        
        // 存储所有词语数据和已提交状态
        let 所有词语 = {};
        let 已提交 = false;
        let 词语列表 = [];
        let 实时订阅 = null;
        
        // 显示调试信息
        function 显示调试信息(消息) {
            调试信息.textContent = `状态: ${消息}`;
            调试信息.classList.remove('hidden');
            console.log('[调试]', 消息);
        }
        
        // 检查用户是否已提交过
        function 检查是否已提交() {
            // 使用localStorage记录提交状态，简单实现每人一次机会
            if (localStorage.getItem('已提交职业理想')) {
                已提交 = true;
                理想输入.disabled = true;
                提交按钮.disabled = true;
                提交按钮.classList.add('bg-gray-400', 'cursor-not-allowed');
                提交按钮.classList.remove('bg-primary', 'hover:bg-primary/90', 'hover:scale-105', 'active:scale-95');
                显示提示('你已经提交过职业理想啦！', 'info');
                显示调试信息('用户已提交过职业理想');
            }
        }
        
        // 显示提示信息
        function 显示提示(消息, 类型 = 'info') {
            状态提示.textContent = 消息;
            状态提示.classList.remove('hidden', 'text-green-600', 'text-red-600', 'text-blue-600');
            
            if (类型 === 'success') {
                状态提示.classList.add('text-green-600');
            } else if (类型 === 'error') {
                状态提示.classList.add('text-red-600');
            } else {
                状态提示.classList.add('text-blue-600');
            }
            
            // 3秒后隐藏提示
            setTimeout(() => {
                状态提示.classList.add('hidden');
            }, 3000);
        }
        
        // 提交职业理想 - 修复数据提交逻辑
        function 提交职业理想() {
            const 词语 = 理想输入.value.trim();
            
            if (!词语) {
                显示提示('请输入你的职业理想词语', 'error');
                return;
            }
            
            if (词语.length > 10) {
                显示提示('词语长度不能超过10个字符', 'error');
                return;
            }
            
            if (!验证LeanCloud初始化()) {
                显示提示('系统初始化失败，请刷新页面重试', 'error');
                return;
            }
            
            // 创建新的记录
            const 新词语 = new CareerIdealWord();
            新词语.set('word', 词语);
            
            提交按钮.disabled = true;
            提交按钮.innerHTML = '<i class="fa fa-spinner fa-spin"></i><span>提交中...</span>';
            显示调试信息(`准备提交词语: ${词语}`);
            
            新词语.save().then((savedObject) => {
                显示调试信息(`提交成功，对象ID: ${savedObject.id}`);
                显示提示('提交成功！感谢你的分享', 'success');
                理想输入.value = '';
                localStorage.setItem('已提交职业理想', 'true');
                检查是否已提交();
                
                // 立即刷新数据
                获取所有词语();
                // 显示刚提交的词语作为弹幕
                显示弹幕(词语);
                
                提交按钮.disabled = false;
                提交按钮.innerHTML = '<i class="fa fa-paper-plane"></i><span>提交理想</span>';
            }).catch(error => {
                显示调试信息(`提交失败: ${error.message}, 错误代码: ${error.code}`);
                let 错误消息 = '提交失败，请稍后再试';
                
                // 根据错误代码提供更具体的信息
                if (error.code === 401) {
                    错误消息 += '，可能是权限设置问题';
                } else if (error.code === 100) {
                    错误消息 += '，网络连接可能有问题';
                }
                
                显示提示(`${错误消息}: ${error.message}`, 'error');
                提交按钮.disabled = false;
                提交按钮.innerHTML = '<i class="fa fa-paper-plane"></i><span>提交理想</span>';
            });
        }
        
        // 获取所有词语并更新词云
        function 获取所有词语() {
            显示调试信息('开始获取所有词语数据');
            
            query.find().then(results => {
                显示调试信息(`成功获取 ${results.length} 条词语数据`);
                所有词语 = {};
                词语列表 = [];
                
                results.forEach(item => {
                    const 词 = item.get('word');
                    词语列表.push(词);
                    所有词语[词] = (所有词语[词] || 0) + 1;
                });
                
                更新词云();
                词云加载中.classList.add('hidden');
            }).catch(error => {
                显示调试信息(`获取数据失败: ${error.message}`);
                显示提示('获取数据失败，请刷新页面重试', 'error');
                词云加载中.classList.add('hidden');
            });
        }
        
        // 更新词云
        function 更新词云() {
            // 准备词云数据格式: [[词, 权重], [词, 权重], ...]
            const 词云数据 = Object.entries(所有词语).map(([词, 次数]) => [词, 次数]);
            显示调试信息(`更新词云，共 ${词云数据.length} 个不同词语`);
            
            if (词云数据.length === 0) {
                // 如果没有数据，显示提示
                const 容器 = 词云容器;
                // 清除可能存在的旧提示
                const 旧提示 = 容器.querySelector('.empty提示');
                if (旧提示) 旧提示.remove();
                
                const 提示 = document.createElement('div');
                提示.className = 'empty提示 absolute inset-0 flex items-center justify-center text-gray-400';
                提示.textContent = '还没有职业理想被提交，快来成为第一个吧！';
                容器.appendChild(提示);
                
                // 移除之前的词云
                const 旧画布 = document.getElementById('词云画布');
                if (旧画布) 旧画布.remove();
                
                return;
            }
            
            // 清除可能存在的空提示
            const 空提示 = 词云容器.querySelector('.empty提示');
            if (空提示) 空提示.remove();
            
            // 清除旧的词云
            词云画布.width = 词云容器.clientWidth;
            词云画布.height = 词云容器.clientHeight;
            
            // 生成词云
            WordCloud(词云画布, {
                list: 词云数据,
                size: 16,
                color: function(word, weight) {
                    // 随机颜色
                    const 颜色列表 = [
                        '#3B82F6', '#10B981', '#8B5CF6', '#EF4444', '#F59E0B',
                        '#EC4899', '#6366F1', '#14B8A6', '#F97316', '#84CC16'
                    ];
                    return 颜色列表[Math.floor(Math.random() * 颜色列表.length)];
                },
                backgroundColor: 'transparent',
                rotateRatio: 0.5, // 50%的词语会旋转
                rotationSteps: 2,
                minSize: 10,
                maxSize: 60,
                drawOutOfBound: false,
                fontFamily: 'Inter, sans-serif'
            });
        }
        
        // 显示弹幕
        function 显示弹幕(文本) {
            const 弹幕 = document.createElement('div');
            弹幕.className = '弹幕元素';
            弹幕.textContent = text;
            
            // 随机样式
            const 字体大小 = Math.floor(Math.random() * 10) + 14; // 14-23px
            const 颜色列表 = [
                '#3B82F6', '#10B981', '#8B5CF6', '#EF4444', '#F59E0B',
                '#EC4899', '#6366F1', '#14B8A6', '#F97316', '#84CC16'
            ];
            const 颜色 = 颜色列表[Math.floor(Math.random() * 颜色列表.length)];
            const 顶部位置 = Math.floor(Math.random() * 80) + 10; // 10-90%
            const 动画时长 = Math.floor(Math.random() * 8) + 8; // 8-16秒
            
            // 应用样式
            弹幕.style.fontSize = `${字体大小}px`;
            弹幕.style.color = 颜色;
            弹幕.style.top = `${顶部位置}%`;
            弹幕.style.animationDuration = `${动画时长}s`;
            弹幕.style.opacity = '0.8';
            
            // 添加到容器
            弹幕容器.appendChild(弹幕);
            
            // 动画结束后移除
            setTimeout(() => {
                弹幕.remove();
            }, 动画时长 * 1000);
        }
        
        // 定期随机显示已有弹幕
        function 定期显示弹幕() {
            if (词语列表.length === 0) {
                setTimeout(定期显示弹幕, 3000);
                return;
            }
            
            const 随机索引 = Math.floor(Math.random() * 词语列表.length);
            显示弹幕(词语列表[随机索引]);
            
            // 随机3-8秒后再次显示
            const 下次时间 = Math.floor(Math.random() * 5000) + 3000;
            setTimeout(定期显示弹幕, 下次时间);
        }
        
        // 设置实时更新
        function 设置实时更新() {
            if (!验证LeanCloud初始化()) return;
            
            // 先取消可能存在的旧订阅
            if (实时订阅) {
                实时订阅.unsubscribe();
            }
            
            // 监听数据变化
            const 实时查询 = new AV.Query(CareerIdealWord);
            
            // 监听新增数据
            实时查询.subscribe().then(subscription => {
                实时订阅 = subscription;
                显示调试信息('实时更新已连接');
                
                subscription.on('create', object => {
                    const 新词 = object.get('word');
                    显示调试信息(`收到新词语: ${新词}`);
                    获取所有词语(); // 更新词云
                    显示弹幕(新词); // 显示新弹幕
                });
                
                subscription.on('error', error => {
                    显示调试信息(`实时更新错误: ${error.message}`);
                    显示提示('实时连接出现问题，将尝试重新连接', 'error');
                    // 尝试重新连接
                    setTimeout(设置实时更新, 5000);
                });
            }).catch(error => {
                显示调试信息(`实时订阅失败: ${error.message}`);
                显示提示('无法建立实时连接，将尝试重新连接', 'error');
                // 尝试重新连接
                setTimeout(设置实时更新, 5000);
            });
        }
        
        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', () => {
            显示调试信息('页面加载完成，开始初始化');
            验证LeanCloud初始化();
            检查是否已提交();
            获取所有词语();
            设置实时更新();
            定期显示弹幕();
            
            // 窗口大小改变时重新绘制词云
            window.addEventListener('resize', 更新词云);
            
            // 提交按钮点击事件
            提交按钮.addEventListener('click', 提交职业理想);
            
            // 输入框回车提交
            理想输入.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    提交职业理想();
                }
            });
        });
    </script>
</body>
</html>
