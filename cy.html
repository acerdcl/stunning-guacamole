<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>职业理想词云系统</title>
  <!-- 外部资源引入 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.2/src/wordcloud2.min.js"></script>
  
  <!-- Tailwind 配置 -->
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4F46E5',
            secondary: '#10B981',
            accent: '#EC4899',
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .danmaku-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 50;
        overflow: hidden;
      }
      .danmaku {
        position: absolute;
        white-space: nowrap;
        animation: danmaku-scroll linear forwards;
        opacity: 0.9;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.3);
      }
      @keyframes danmaku-scroll {
        from { transform: translateX(100vw); }
        to { transform: translateX(-100%); }
      }
    }
  </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 to-blue-50 min-h-screen font-sans text-gray-800">
  <!-- 页面容器 -->
  <div class="container mx-auto px-4 py-6 max-w-6xl">
    
    <!-- 标题区域 -->
    <header class="text-center mb-6 md:mb-8">
      <h1 class="text-[clamp(1.8rem,5vw,3rem)] font-bold text-primary mb-2 text-shadow">职业理想词云</h1>
      <p class="text-gray-600 text-base md:text-lg">分享你的职业理想，共同描绘我们的未来</p>
    </header>
    
    <!-- 主要内容区域 -->
    <main class="flex flex-col lg:flex-row gap-6">
      
      <!-- 左侧：词云展示区 -->
      <div class="lg:w-2/3 bg-white rounded-xl shadow-lg p-4 md:p-6 transform transition-all duration-300 hover:shadow-xl">
        <h2 class="text-xl font-semibold mb-4 flex items-center">
          <i class="fa fa-cloud text-primary mr-2"></i> 班级职业理想词云
        </h2>
        <div class="relative w-full aspect-square md:aspect-[4/3] bg-gray-50 rounded-lg overflow-hidden" id="wordcloud-container">
          <canvas id="wordcloud-canvas" class="w-full h-full"></canvas>
          <div id="loading-indicator" class="absolute inset-0 flex items-center justify-center bg-white/80 z-10">
            <div class="text-center">
              <div class="inline-block animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary mb-3"></div>
              <p class="text-gray-600">加载词云数据中...</p>
            </div>
          </div>
        </div>
      </div>
      
      <!-- 右侧：输入区和统计 -->
      <div class="lg:w-1/3 flex flex-col gap-6">
        <!-- 输入区域 -->
        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 transform transition-all duration-300 hover:shadow-xl">
          <h2 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fa fa-pencil text-secondary mr-2"></i> 分享你的职业理想
          </h2>
          <p class="text-gray-600 mb-4 text-sm">请输入一个词来代表你的职业理想，如"自由"、"成长"等</p>
          
          <form id="input-form" class="space-y-4">
            <div>
              <input 
                type="text" 
                id="ideal-input" 
                placeholder="输入你的职业理想..." 
                class="w-full px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary focus:border-primary transition-all outline-none"
                maxlength="10"
                required
              >
            </div>
            <button 
              type="submit" 
              id="submit-btn"
              class="w-full bg-primary hover:bg-primary/90 text-white font-medium py-3 px-4 rounded-lg transition-all transform hover:scale-[1.02] active:scale-[0.98] flex items-center justify-center"
            >
              <i class="fa fa-paper-plane mr-2"></i> 提交
            </button>
          </form>
          
          <div id="feedback-message" class="mt-4 hidden"></div>
          <div id="debug-info" class="mt-2 text-xs text-gray-500 hidden"></div>
        </div>
        
        <!-- 统计信息 -->
        <div class="bg-white rounded-xl shadow-lg p-4 md:p-6 transform transition-all duration-300 hover:shadow-xl">
          <h2 class="text-xl font-semibold mb-4 flex items-center">
            <i class="fa fa-bar-chart text-accent mr-2"></i> 统计信息
          </h2>
          <div class="space-y-3 text-gray-700">
            <div class="flex justify-between items-center">
              <span>参与人数：</span>
              <span id="participant-count" class="font-semibold">0</span>
            </div>
            <div class="flex justify-between items-center">
              <span>总词汇数：</span>
              <span id="word-count" class="font-semibold">0</span>
            </div>
            <div class="flex justify-between items-center">
              <span>热门理想：</span>
              <span id="popular-ideal" class="font-semibold">-</span>
            </div>
          </div>
        </div>
      </div>
    </main>
    
    <!-- 页脚 -->
    <footer class="mt-10 text-center text-gray-500 text-sm">
      <p>职业理想词云系统 &copy; 2023</p>
    </footer>
  </div>
  
  <!-- 弹幕容器 -->
  <div class="danmaku-container" id="danmaku-container"></div>

  <script>
    // 初始化LeanCloud
    AV.init({
      appId: "uJ3KsasvmBzf9Xn2OodGclFx-gzGzoHsz",
      appKey: "JEsdiH1q5v1NzqyLCLqJVWvt",
      serverURLs: "https://uj3ksasv.lc-cn-n1-shared.com"
    });
    
    // 检查LeanCloud初始化状态
    function checkLeanCloudInit() {
      const debugInfo = document.getElementById('debug-info');
      try {
        if (AV.applicationId && AV.applicationId === "uJ3KsasvmBzf9Xn2OodGclFx-gzGzoHsz") {
          debugInfo.textContent = "LeanCloud初始化成功";
          debugInfo.classList.remove('hidden', 'text-red-500');
          debugInfo.classList.add('text-green-500');
        } else {
          debugInfo.textContent = "LeanCloud初始化失败：AppID不正确";
          debugInfo.classList.remove('hidden', 'text-green-500');
          debugInfo.classList.add('text-red-500');
        }
      } catch (e) {
        debugInfo.textContent = `LeanCloud初始化错误：${e.message}`;
        debugInfo.classList.remove('hidden', 'text-green-500');
        debugInfo.classList.add('text-red-500');
      }
    }
    
    // 获取数据存储类
    const CareerIdealWord = AV.Object.extend('CareerIdealWord');
    
    // DOM元素
    const inputForm = document.getElementById('input-form');
    const idealInput = document.getElementById('ideal-input');
    const submitBtn = document.getElementById('submit-btn');
    const feedbackMessage = document.getElementById('feedback-message');
    const wordcloudContainer = document.getElementById('wordcloud-container');
    const wordcloudCanvas = document.getElementById('wordcloud-canvas');
    const loadingIndicator = document.getElementById('loading-indicator');
    const danmakuContainer = document.getElementById('danmaku-container');
    const participantCount = document.getElementById('participant-count');
    const wordCount = document.getElementById('word-count');
    const popularIdeal = document.getElementById('popular-ideal');
    const debugInfo = document.getElementById('debug-info');
    
    // 全局变量
    let allWords = [];
    let wordFrequencies = {};
    let userSubmitted = false;
    let danmakuTimer = null;
    
    // 检查用户是否已提交
    function checkUserSubmissionStatus() {
      const submitted = localStorage.getItem('careerIdealSubmitted');
      if (submitted) {
        userSubmitted = true;
        idealInput.disabled = true;
        submitBtn.disabled = true;
        submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
        submitBtn.classList.remove('bg-primary', 'hover:bg-primary/90', 'hover:scale-[1.02]', 'active:scale-[0.98]');
        showFeedback('你已提交过职业理想，感谢参与！', 'info');
      }
    }
    
    // 显示提交反馈
    function showFeedback(message, type = 'success') {
      feedbackMessage.textContent = message;
      feedbackMessage.classList.remove('hidden', 'text-green-600', 'text-red-600', 'text-blue-600', 'p-3', 'rounded-lg', 'bg-green-50', 'bg-red-50', 'bg-blue-50');
      
      if (type === 'success') {
        feedbackMessage.classList.add('text-green-600', 'p-3', 'rounded-lg', 'bg-green-50');
      } else if (type === 'error') {
        feedbackMessage.classList.add('text-red-600', 'p-3', 'rounded-lg', 'bg-red-50');
      } else if (type === 'info') {
        feedbackMessage.classList.add('text-blue-600', 'p-3', 'rounded-lg', 'bg-blue-50');
      }
      
      // 3秒后隐藏信息（成功和错误信息）
      if (type !== 'info') {
        setTimeout(() => {
          feedbackMessage.classList.add('hidden');
        }, 3000);
      }
    }
    
    // 提交职业理想
    async function submitCareerIdeal(word) {
      if (userSubmitted) return;
      
      // 简单验证
      if (!word || word.trim() === '') {
        showFeedback('请输入有效的职业理想', 'error');
        return;
      }
      
      submitBtn.disabled = true;
      submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin mr-2"></i> 提交中...';
      
      try {
        // 创建新记录
        const newWord = new CareerIdealWord();
        newWord.set('word', word.trim());
        
        // 显示调试信息
        debugInfo.textContent = `准备提交: ${word.trim()}`;
        debugInfo.classList.remove('hidden');
        
        // 保存到LeanCloud
        const result = await newWord.save();
        
        // 提交成功，显示对象ID
        debugInfo.textContent = `提交成功! 对象ID: ${result.id}`;
        debugInfo.classList.remove('text-red-500');
        debugInfo.classList.add('text-green-500');
        
        // 标记用户已提交
        localStorage.setItem('careerIdealSubmitted', 'true');
        userSubmitted = true;
        
        showFeedback('提交成功！感谢你的参与', 'success');
        
        // 禁用输入和按钮
        idealInput.disabled = true;
        submitBtn.disabled = true;
        submitBtn.classList.add('bg-gray-400', 'cursor-not-allowed');
        submitBtn.classList.remove('bg-primary', 'hover:bg-primary/90', 'hover:scale-[1.02]', 'active:scale-[0.98]');
        submitBtn.innerHTML = '<i class="fa fa-check mr-2"></i> 已提交';
        
        // 手动触发一次数据更新
        getAllWords();
        
      } catch (error) {
        console.error('提交失败:', error);
        // 显示详细错误信息
        let errorMsg = '提交失败: ';
        if (error.message) errorMsg += error.message;
        if (error.code) errorMsg += ` (错误代码: ${error.code})`;
        
        showFeedback(errorMsg, 'error');
        debugInfo.textContent = errorMsg;
        debugInfo.classList.remove('hidden', 'text-green-500');
        debugInfo.classList.add('text-red-500');
        
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<i class="fa fa-paper-plane mr-2"></i> 提交';
      }
    }
    
    // 获取所有词语数据
    async function getAllWords() {
      try {
        const query = new AV.Query(CareerIdealWord);
        query.descending('createdAt'); // 按时间倒序
        const results = await query.find();
        
        // 显示获取到的数据量
        debugInfo.textContent = `成功获取 ${results.length} 条数据`;
        debugInfo.classList.remove('hidden', 'text-red-500');
        debugInfo.classList.add('text-green-500');
        
        // 处理结果
        allWords = results.map(item => item.get('word'));
        
        // 计算频率
        calculateWordFrequencies();
        
        // 更新统计信息
        updateStatistics();
        
        // 生成词云
        generateWordCloud();
        
        // 隐藏加载提示
        loadingIndicator.classList.add('hidden');
        
        return allWords;
      } catch (error) {
        console.error('获取数据失败:', error);
        let errorMsg = '获取数据失败: ';
        if (error.message) errorMsg += error.message;
        if (error.code) errorMsg += ` (错误代码: ${error.code})`;
        
        loadingIndicator.innerHTML = `<p class="text-red-600">${errorMsg}</p>`;
        debugInfo.textContent = errorMsg;
        debugInfo.classList.remove('hidden', 'text-green-500');
        debugInfo.classList.add('text-red-500');
        
        return [];
      }
    }
    
    // 计算词语频率
    function calculateWordFrequencies() {
      wordFrequencies = {};
      allWords.forEach(word => {
        const lowerWord = word.toLowerCase(); // 不区分大小写
        wordFrequencies[lowerWord] = (wordFrequencies[lowerWord] || 0) + 1;
      });
    }
    
    // 更新统计信息
    function updateStatistics() {
      // 参与人数 = 记录总数
      participantCount.textContent = allWords.length;
      
      // 总词汇数 = 不同词语的数量
      wordCount.textContent = Object.keys(wordFrequencies).length;
      
      // 热门理想 = 频率最高的词
      if (Object.keys(wordFrequencies).length > 0) {
        let maxFrequency = 0;
        let mostPopularWord = '';
        
        for (const [word, frequency] of Object.entries(wordFrequencies)) {
          if (frequency > maxFrequency) {
            maxFrequency = frequency;
            mostPopularWord = word;
          }
        }
        
        popularIdeal.textContent = `${mostPopularWord} (${maxFrequency}次)`;
      }
    }
    
    // 生成词云
    function generateWordCloud() {
      if (Object.keys(wordFrequencies).length === 0) {
        // 清空画布并显示提示
        const ctx = wordcloudCanvas.getContext('2d');
        ctx.clearRect(0, 0, wordcloudCanvas.width, wordcloudCanvas.height);
        ctx.font = '16px sans-serif';
        ctx.fillStyle = '#666';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText('暂无数据，请先提交职业理想', wordcloudCanvas.width / 2, wordcloudCanvas.height / 2);
        return;
      }
      
      // 准备词云数据格式：[{text: '词', size: 频率}, ...]
      const wordcloudData = Object.entries(wordFrequencies).map(([word, frequency]) => {
        // 调整大小范围
        const baseSize = 10;
        const maxSize = 60;
        const frequencyArray = Object.values(wordFrequencies);
        const maxFrequency = Math.max(...frequencyArray);
        let size = baseSize + (frequency / maxFrequency) * (maxSize - baseSize);
        return { text: word, size: size };
      });
      
      // 配置词云
      const config = {
        list: wordcloudData,
        fontFamily: 'sans-serif',
        color: function() {
          // 随机颜色
          const colors = ['#4F46E5', '#10B981', '#EC4899', '#EF4444', '#F59E0B', '#6366F1', '#14B8A6'];
          return colors[Math.floor(Math.random() * colors.length)];
        },
        rotationRange: [-30, 30], // 旋转角度范围
        backgroundColor: 'transparent',
        shuffle: true,
        rotateRatio: 0.5, // 50%的词会旋转
        minSize: 10,
        gridSize: 8,
        drawOutOfBound: false
      };
      
      // 调整画布大小以适应容器
      function resizeCanvas() {
        const containerWidth = wordcloudContainer.clientWidth;
        const containerHeight = wordcloudContainer.clientHeight;
        wordcloudCanvas.width = containerWidth;
        wordcloudCanvas.height = containerHeight;
      }
      
      // 调整大小并生成词云
      resizeCanvas();
      window.addEventListener('resize', () => {
        resizeCanvas();
        wordcloud(wordcloudCanvas, config);
      });
      
      // 生成词云
      wordcloud(wordcloudCanvas, config);
    }
    
    // 创建弹幕
    function createDanmaku(text) {
      if (!text) return;
      
      const danmaku = document.createElement('div');
      danmaku.className = 'danmaku';
      danmaku.textContent = text;
      
      // 随机样式
      const colors = ['#4F46E5', '#10B981', '#EC4899', '#EF4444', '#F59E0B', '#6366F1', '#14B8A6'];
      danmaku.style.color = colors[Math.floor(Math.random() * colors.length)];
      
      const size = Math.floor(Math.random() * 4) + 14; // 14px 到 17px
      danmaku.style.fontSize = `${size}px`;
      
      // 随机垂直位置（避免顶部和底部）
      const top = Math.floor(Math.random() * 70) + 10; // 10% 到 80%
      danmaku.style.top = `${top}%`;
      
      // 随机动画持续时间（5-15秒）
      const duration = Math.floor(Math.random() * 10) + 5;
      danmaku.style.animationDuration = `${duration}s`;
      
      // 添加到容器
      danmakuContainer.appendChild(danmaku);
      
      // 动画结束后移除
      setTimeout(() => {
        danmaku.remove();
      }, duration * 1000);
    }
    
    // 随机展示已有弹幕
    function showRandomDanmaku() {
      if (allWords.length === 0) return;
      
      // 随机选择一个词
      const randomIndex = Math.floor(Math.random() * allWords.length);
      const randomWord = allWords[randomIndex];
      
      createDanmaku(randomWord);
    }
    
    // 启动定期展示弹幕
    function startDanmakuTimer() {
      // 每3-8秒随机展示一个已有弹幕
      if (danmakuTimer) clearInterval(danmakuTimer);
      
      danmakuTimer = setInterval(() => {
        showRandomDanmaku();
      }, Math.floor(Math.random() * 5000) + 3000); // 3000-8000ms
    }
    
    // 设置实时更新监听
    function setupRealtimeListener() {
      try {
        const query = new AV.Query(CareerIdealWord);
        const realtimeQuery = AV.Realtime.createQuery(query);
        
        // 监听新增数据
        realtimeQuery.subscribe().then(() => {
          debugInfo.textContent = "实时监听已启动";
          realtimeQuery.on('create', (object) => {
            const newWord = object.get('word');
            allWords.unshift(newWord); // 添加到数组开头
            calculateWordFrequencies();
            updateStatistics();
            generateWordCloud();
            
            // 显示新弹幕
            createDanmaku(newWord);
          });
        }).catch(error => {
          console.error('实时监听设置失败:', error);
          debugInfo.textContent = `实时监听失败: ${error.message}`;
        });
      } catch (error) {
        console.error('设置实时监听时出错:', error);
        debugInfo.textContent = `设置实时监听错误: ${error.message}`;
      }
    }
    
    // 初始化
    function init() {
      // 显示调试信息区域
      debugInfo.classList.remove('hidden');
      
      // 检查LeanCloud初始化状态
      checkLeanCloudInit();
      
      // 检查用户提交状态
      checkUserSubmissionStatus();
      
      // 获取所有词语数据
      getAllWords();
      
      // 设置实时监听
      setupRealtimeListener();
      
      // 启动弹幕定时器
      startDanmakuTimer();
      
      // 表单提交事件
      inputForm.addEventListener('submit', (e) => {
        e.preventDefault();
        submitCareerIdeal(idealInput.value);
        idealInput.value = '';
      });
    }
    
    // 页面加载完成后初始化
    window.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
