<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>班级职业理想词云</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入词云库 -->
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.0/src/wordcloud2.min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#ECFDF5',
                        accent: '#0EA5E9',
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            .wordcloud-container {
                min-height: 400px;
                position: relative;
            }
            .danmaku {
                position: absolute;
                white-space: nowrap;
                animation: danmaku 8s linear forwards;
            }
            @keyframes danmaku {
                from { transform: translateX(100%); }
                to { transform: translateX(-100%); }
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <div class="container mx-auto px-4 py-8 max-w-6xl">
        <header class="text-center mb-10">
            <h1 class="text-[clamp(1.8rem,4vw,2.5rem)] font-bold text-gray-800 mb-2">
                <i class="fa fa-cloud text-primary mr-2"></i>班级职业理想词云
            </h1>
            <p class="text-gray-600">分享你的职业理想，共同描绘我们的未来蓝图</p>
        </header>
        
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- 词云展示区域 -->
            <div class="lg:col-span-2 bg-white rounded-xl p-6 card-shadow">
                <div id="wordcloud" class="wordcloud-container w-full">
                    <!-- 词云将在这里生成 -->
                    <div id="wordcloud-placeholder" class="flex items-center justify-center h-full text-gray-400">
                        <i class="fa fa-spinner fa-spin mr-2"></i> 正在加载词云...
                    </div>
                    <div id="error-message" class="hidden text-center text-red-500 py-10"></div>
                </div>
            </div>
            
            <!-- 右侧边栏 -->
            <div class="space-y-6">
                <!-- 提交表单 -->
                <div class="bg-white rounded-xl p-6 card-shadow">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fa fa-pencil text-accent mr-2"></i>分享你的职业理想
                    </h2>
                    <p class="text-gray-600 mb-4">请输入一个词来代表你的职业理想，如"自由"、"成长"等</p>
                    
                    <form id="career-form" class="space-y-4">
                        <input type="text" 
                               id="career-input" 
                               placeholder="输入你的职业理想..." 
                               class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary transition-all"
                               maxlength="10"
                               required>
                        
                        <button type="submit" class="w-full bg-primary hover:bg-primary/90 text-white py-2 px-4 rounded-lg transition-all flex items-center justify-center">
                            <i class="fa fa-paper-plane mr-2"></i> 提交
                        </button>
                    </form>
                    
                    <div id="submitted-message" class="mt-4 hidden bg-green-50 text-green-600 p-3 rounded-lg text-center">
                        你已提交过职业理想，感谢参与！
                    </div>
                </div>
                
                <!-- 统计信息 -->
                <div class="bg-white rounded-xl p-6 card-shadow">
                    <h2 class="text-xl font-semibold mb-4 flex items-center">
                        <i class="fa fa-bar-chart text-orange-500 mr-2"></i>统计信息
                    </h2>
                    <div class="space-y-3 text-gray-700">
                        <div class="flex justify-between">
                            <span>参与人数:</span>
                            <span id="participant-count" class="font-medium">0</span>
                        </div>
                        <div class="flex justify-between">
                            <span>总词汇数:</span>
                            <span id="total-words" class="font-medium">0</span>
                        </div>
                        <div>
                            <span>热门理想:</span>
                            <div id="popular-words" class="font-medium mt-1">
                                暂无数据
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 弹幕容器 -->
        <div id="danmaku-container" class="fixed top-0 left-0 w-full h-full pointer-events-none overflow-hidden z-10"></div>
    </div>

    <script>
        // 存储已提交的职业理想数据
        let careerData = [];
        let userSubmitted = false;
        const STORAGE_KEY = 'career_ideal_submitted';
        const USER_INPUT_KEY = 'user_career_ideal';
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 检查用户是否已提交过
            checkUserSubmission();
            
            // 加载数据并初始化词云
            loadCareerData();
            
            // 表单提交事件
            document.getElementById('career-form').addEventListener('submit', handleFormSubmit);
        });
        
        // 检查用户是否已提交过职业理想
        function checkUserSubmission() {
            const submitted = localStorage.getItem(STORAGE_KEY);
            if (submitted === 'true') {
                userSubmitted = true;
                document.getElementById('career-form').classList.add('hidden');
                document.getElementById('submitted-message').classList.remove('hidden');
            }
        }
        
        // 加载职业理想数据
        function loadCareerData() {
            // 模拟从服务器加载数据
            // 在实际应用中，这里应该是一个真实的API请求
            setTimeout(() => {
                // 模拟数据 - 实际应用中应替换为真实API响应
                const mockData = [
                    { word: '高薪', count: 12 },
                    { word: '自由', count: 9 },
                    { word: '成长', count: 8 },
                    { word: '创新', count: 7 },
                    { word: '稳定', count: 6 },
                    { word: '挑战', count: 5 },
                    { word: '贡献', count: 4 },
                    { word: '领导', count: 3 },
                    { word: '专业', count: 3 },
                    { word: '平衡', count: 2 }
                ];
                
                // 如果用户之前提交过，添加到数据中
                const userIdeal = localStorage.getItem(USER_INPUT_KEY);
                if (userIdeal) {
                    const existing = mockData.find(item => item.word === userIdeal);
                    if (existing) {
                        existing.count++;
                    } else {
                        mockData.push({ word: userIdeal, count: 1 });
                    }
                }
                
                careerData = mockData;
                updateStatistics();
                renderWordCloud();
                startDanmaku();
            }, 800);
        }
        
        // 处理表单提交
        function handleFormSubmit(e) {
            e.preventDefault();
            const input = document.getElementById('career-input');
            const careerIdeal = input.value.trim();
            
            if (careerIdeal) {
                // 保存到本地存储，标记为已提交
                localStorage.setItem(STORAGE_KEY, 'true');
                localStorage.setItem(USER_INPUT_KEY, careerIdeal);
                
                // 更新UI
                userSubmitted = true;
                document.getElementById('career-form').classList.add('hidden');
                document.getElementById('submitted-message').classList.remove('hidden');
                
                // 添加到数据中并更新词云
                const existing = careerData.find(item => item.word === careerIdeal);
                if (existing) {
                    existing.count++;
                } else {
                    careerData.push({ word: careerIdeal, count: 1 });
                }
                
                updateStatistics();
                renderWordCloud();
                addDanmaku(careerIdeal);
                
                // 显示成功提示
                alert('你的职业理想已提交成功！');
            }
        }
        
        // 更新统计信息
        function updateStatistics() {
            // 参与人数统计（简单处理，实际应从服务器获取）
            const participantCount = userSubmitted ? 1 + Math.floor(Math.random() * 50) : Math.floor(Math.random() * 50);
            document.getElementById('participant-count').textContent = participantCount;
            
            // 总词汇数
            document.getElementById('total-words').textContent = careerData.length;
            
            // 热门理想（取前3名）
            const sorted = [...careerData].sort((a, b) => b.count - a.count);
            const topWords = sorted.slice(0, 3);
            
            let popularHtml = '';
            topWords.forEach(word => {
                popularHtml += `<div>${word.word} (${word.count}次)</div>`;
            });
            
            document.getElementById('popular-words').innerHTML = popularHtml;
        }
        
        // 渲染词云
        function renderWordCloud() {
            try {
                // 检查WordCloud库是否加载成功
                if (typeof WordCloud === 'undefined') {
                    throw new Error('词云库加载失败');
                }
                
                // 准备词云数据格式：[[word, size], [word, size], ...]
                const wordList = careerData.map(item => {
                    // 根据出现次数计算字体大小，范围在10-80之间
                    const size = Math.min(10 + item.count * 5, 80);
                    return [item.word, size];
                });
                
                // 隐藏占位符，显示词云
                document.getElementById('wordcloud-placeholder').classList.add('hidden');
                document.getElementById('error-message').classList.add('hidden');
                
                // 清除已存在的词云
                const container = document.getElementById('wordcloud');
                container.innerHTML = '';
                
                // 创建词云容器
                const canvas = document.createElement('canvas');
                canvas.id = 'wordcloud-canvas';
                canvas.width = container.clientWidth;
                canvas.height = 400;
                container.appendChild(canvas);
                
                // 生成词云
                WordCloud(canvas, {
                    list: wordList,
                    backgroundColor: '#ffffff',
                    color: function(word, weight) {
                        // 随机颜色
                        const colors = ['#4F46E5', '#0EA5E9', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6'];
                        return colors[Math.floor(Math.random() * colors.length)];
                    },
                    fontFamily: 'Inter, sans-serif',
                    rotateRatio: 0.3, // 30%的词语会旋转
                    minSize: 10,
                    gridSize: 8,
                    drawMask: false
                });
                
            } catch (error) {
                console.error('词云生成失败:', error);
                document.getElementById('wordcloud-placeholder').classList.add('hidden');
                const errorElement = document.getElementById('error-message');
                errorElement.classList.remove('hidden');
                errorElement.textContent = `获取数据失败: ${error.message}`;
            }
        }
        
        // 弹幕相关功能
        function startDanmaku() {
            // 初始发送一些弹幕
            careerData.forEach(item => {
                // 根据出现次数决定发送多少个该词语的弹幕
                const count = Math.min(item.count, 5); // 最多5个
                for (let i = 0; i < count; i++) {
                    setTimeout(() => {
                        addDanmaku(item.word);
                    }, i * 1000);
                }
            });
            
            // 定时发送随机弹幕
            setInterval(() => {
                if (careerData.length > 0) {
                    const randomIndex = Math.floor(Math.random() * careerData.length);
                    addDanmaku(careerData[randomIndex].word);
                }
            }, 3000);
        }
        
        function addDanmaku(text) {
            const container = document.getElementById('danmaku-container');
            const danmaku = document.createElement('div');
            danmaku.className = 'danmaku';
            danmaku.textContent = text;
            
            // 随机样式
            const size = 14 + Math.random() * 8; // 14-22px
            const color = getRandomColor();
            const top = Math.random() * (container.clientHeight - 40); // 避免超出屏幕
            const duration = 5 + Math.random() * 10; // 5-15秒
            
            danmaku.style.fontSize = `${size}px`;
            danmaku.style.color = color;
            danmaku.style.top = `${top}px`;
            danmaku.style.animationDuration = `${duration}s`;
            
            container.appendChild(danmaku);
            
            // 动画结束后移除元素
            setTimeout(() => {
                danmaku.remove();
            }, duration * 1000);
        }
        
        function getRandomColor() {
            const colors = [
                '#4F46E5', '#0EA5E9', '#10B981', '#F59E0B', 
                '#EF4444', '#8B5CF6', '#EC4899', '#6B7280'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }
        
        // 窗口大小改变时重新渲染词云
        window.addEventListener('resize', renderWordCloud);
    </script>
</body>
</html>
