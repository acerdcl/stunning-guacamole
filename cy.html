<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>职业理想词云</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <!-- 引入LeanCloud SDK -->
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <!-- 引入词云库 - 使用更可靠的CDN -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.1/wordcloud2.min.js"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#8B5CF6',
                        dark: '#1F2937',
                        light: '#F3F4F6'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .animate-float {
                animation: float 6s ease-in-out infinite;
            }
            .backdrop-blur {
                backdrop-filter: blur(8px);
            }
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        .danmaku {
            position: absolute;
            white-space: nowrap;
            z-index: 10;
            pointer-events: none;
            animation-timing-function: linear;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-purple-50 min-h-screen font-sans">
    <!-- 顶部导航 -->
    <header class="bg-white/80 backdrop-blur shadow-sm fixed top-0 left-0 right-0 z-50 transition-all duration-300">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-cloud text-primary text-2xl"></i>
                <h1 class="text-xl md:text-2xl font-bold text-dark">职业理想词云</h1>
            </div>
            <div class="text-sm text-gray-600" id="countDisplay">
                已有 <span id="wordCount">0</span> 个职业理想
            </div>
        </div>
    </header>

    <!-- 主要内容区 -->
    <main class="container mx-auto px-4 pt-20 pb-16">
        <!-- 词云展示区 -->
        <div class="relative bg-white rounded-xl shadow-md p-4 md:p-6 mb-8 overflow-hidden">
            <h2 class="text-center text-lg md:text-xl font-semibold mb-4 text-dark">班级职业理想词云</h2>
            <div class="relative w-full" style="height: 400px;">
                <canvas id="wordcloudCanvas" class="w-full h-full"></canvas>
                <div id="wordcloudLoading" class="absolute inset-0 flex items-center justify-center bg-white/70 z-10">
                    <div class="text-center">
                        <i class="fa fa-circle-o-notch fa-spin text-primary text-3xl mb-2"></i>
                        <p class="text-gray-600">加载词云数据中...</p>
                    </div>
                </div>
                <div id="wordcloudError" class="absolute inset-0 flex items-center justify-center bg-white/70 z-10 hidden">
                    <div class="text-center">
                        <i class="fa fa-exclamation-triangle text-yellow-500 text-3xl mb-2"></i>
                        <p class="text-gray-600" id="errorMessage">获取数据失败</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- 弹幕显示区 -->
        <div class="relative bg-dark rounded-xl shadow-md overflow-hidden mb-8">
            <div class="absolute top-0 left-0 right-0 bg-black/30 text-white p-2 text-center text-sm z-20">
                实时职业理想弹幕
            </div>
            <div id="danmakuContainer" class="w-full h-64 md:h-80 relative overflow-hidden">
                <!-- 弹幕会动态添加到这里 -->
            </div>
        </div>

        <!-- 输入区域 -->
        <div class="bg-white rounded-xl shadow-md p-4 md:p-6">
            <h2 class="text-center text-lg md:text-xl font-semibold mb-4 text-dark">分享你的职业理想</h2>
            <form id="wordForm" class="flex flex-col md:flex-row gap-3">
                <input 
                    type="text" 
                    id="wordInput" 
                    placeholder="输入一个词描述你的职业理想，如：自由、创新、稳定..." 
                    class="flex-1 px-4 py-3 rounded-lg border border-gray-300 focus:outline-none focus:ring-2 focus:ring-primary/50 focus:border-primary transition-all"
                    maxlength="10"
                    required
                >
                <button 
                    type="submit" 
                    id="submitBtn"
                    class="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg font-medium transition-all transform hover:scale-105 active:scale-95 flex items-center justify-center gap-2"
                >
                    <i class="fa fa-paper-plane"></i>
                    <span>提交</span>
                </button>
            </form>
            <p id="message" class="mt-3 text-center text-sm hidden"></p>
            <p class="mt-2 text-center text-xs text-gray-500">每个设备只能提交一次，请认真思考后输入</p>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-dark text-white/80 py-4">
        <div class="container mx-auto px-4 text-center text-sm">
            <p>职业理想词云系统 &copy; 2023</p>
        </div>
    </footer>

    <script>
        // 初始化LeanCloud
        AV.init({
            appId: "uJ3KsasvmBzf9Xn2OodGclFx-gzGzoHsz",
            appKey: "JEsdiH1q5v1NzqyLCLqJVWvt",
            serverURLs: "https://uj3ksasv.lc-cn-n1-shared.com"
        });

        // 获取类
        const CareerIdealWord = AV.Object.extend('CareerIdealWord');
        const query = new AV.Query(CareerIdealWord);

        // DOM元素
        const wordForm = document.getElementById('wordForm');
        const wordInput = document.getElementById('wordInput');
        const message = document.getElementById('message');
        const submitBtn = document.getElementById('submitBtn');
        const wordCount = document.getElementById('wordCount');
        const danmakuContainer = document.getElementById('danmakuContainer');
        const wordcloudCanvas = document.getElementById('wordcloudCanvas');
        const wordcloudLoading = document.getElementById('wordcloudLoading');
        const wordcloudError = document.getElementById('wordcloudError');
        const errorMessage = document.getElementById('errorMessage');

        // 存储所有词语
        let allWords = [];
        let wordFrequency = {};
        let hasSubmitted = localStorage.getItem('hasSubmitted') === 'true';
        let wordcloudLoaded = false; // 词云库加载状态
        let wordcloudQueue = false; // 是否有等待处理的词云生成任务

        // 检查词云库是否加载
        function checkWordcloudLibrary() {
            return new Promise((resolve, reject) => {
                // 如果已经加载完成
                if (window.WordCloud) {
                    wordcloudLoaded = true;
                    return resolve(true);
                }
                
                // 检查次数限制，避免无限循环
                let checkCount = 0;
                const maxChecks = 30; // 最多检查30次，约30秒
                
                // 定期检查
                const checkInterval = setInterval(() => {
                    checkCount++;
                    
                    if (window.WordCloud) {
                        clearInterval(checkInterval);
                        wordcloudLoaded = true;
                        resolve(true);
                    } else if (checkCount >= maxChecks) {
                        clearInterval(checkInterval);
                        reject(new Error('词云库加载超时'));
                    }
                }, 1000); // 每秒检查一次
            });
        }

        // 检查是否已提交
        if (hasSubmitted) {
            wordInput.disabled = true;
            submitBtn.disabled = true;
            submitBtn.classList.add('bg-gray-400', 'hover:bg-gray-400', 'cursor-not-allowed');
            showMessage('你已提交过职业理想，感谢参与！', 'blue');
        }

        // 生成随机颜色
        function getRandomColor() {
            const colors = [
                '#3B82F6', '#10B981', '#8B5CF6', '#EF4444', '#F59E0B', 
                '#EC4899', '#6366F1', '#14B8A6', '#F97316', '#84CC16'
            ];
            return colors[Math.floor(Math.random() * colors.length)];
        }

        // 添加弹幕
        function addDanmaku(text, isNew = false) {
            const danmaku = document.createElement('div');
            danmaku.className = 'danmaku';
            danmaku.textContent = text;
            
            // 随机样式
            const size = Math.floor(Math.random() * 4) + 14; // 14-17px
            const color = getRandomColor();
            const top = Math.floor(Math.random() * (danmakuContainer.clientHeight - 40));
            
            danmaku.style.fontSize = `${size}px`;
            danmaku.style.color = color;
            danmaku.style.top = `${top}px`;
            danmaku.style.right = `-${danmaku.offsetWidth}px`;
            
            // 添加到容器
            danmakuContainer.appendChild(danmaku);
            
            // 计算动画时间 (速度)
            const duration = Math.floor(Math.random() * 8) + 8; // 8-16秒
            
            // 动画
            setTimeout(() => {
                danmaku.style.transition = `transform ${duration}s linear`;
                danmaku.style.transform = `translateX(-${danmakuContainer.clientWidth + danmaku.offsetWidth}px)`;
                
                // 动画结束后移除
                setTimeout(() => {
                    if (danmaku.parentNode) {
                        danmaku.parentNode.removeChild(danmaku);
                    }
                }, duration * 1000);
            }, 10);
            
            // 新提交的弹幕添加特殊标记
            if (isNew) {
                danmaku.classList.add('font-bold');
                danmaku.style.textShadow = '0 0 5px rgba(255,255,255,0.8)';
            }
        }

        // 定期随机展示已有弹幕
        function startRandomDanmaku() {
            setInterval(() => {
                if (allWords.length > 0) {
                    const randomIndex = Math.floor(Math.random() * allWords.length);
                    addDanmaku(allWords[randomIndex]);
                }
            }, 3000);
        }

        // 生成词云
        async function generateWordCloud() {
            // 如果已经有排队的任务，直接返回
            if (wordcloudQueue) return;
            
            wordcloudQueue = true;
            
            try {
                // 确保词云库已加载
                await checkWordcloudLibrary();
                
                // 准备词云数据 - 只使用学生输入的词语
                const wordList = Object.entries(wordFrequency).map(([word, count]) => {
                    // 根据出现次数调整权重
                    const weight = Math.min(10, Math.max(1, count));
                    return [word, weight];
                });
                
                if (wordList.length === 0) {
                    showWordcloudError('暂无数据，请等待其他同学提交');
                    return;
                }
                
                // 清除现有词云
                if (wordcloudCanvas.wordcloud) {
                    wordcloudCanvas.wordcloud.destroy();
                }
                
                // 配置词云
                const options = {
                    list: wordList,
                    color: function() {
                        return getRandomColor();
                    },
                    backgroundColor: 'transparent',
                    minSize: 12,
                    maxSize: 80,
                    rotateRatio: 0.5, // 50%的词语会旋转
                    shape: 'circle',
                    fontFamily: 'Inter, sans-serif',
                    fontWeight: 'bold',
                    gridSize: 8,
                    shuffle: true,
                    hover: function(item, dimension, event) {
                        // 鼠标悬停效果
                        event.target.style.textShadow = '0 0 8px rgba(255,255,255,0.8)';
                    },
                    outOfBound: function() {
                        return false;
                    }
                };
                
                // 生成词云
                WordCloud(wordcloudCanvas, options);
                wordcloudLoading.classList.add('hidden');
                wordcloudError.classList.add('hidden');
            } catch (error) {
                console.error('词云生成错误:', error);
                showWordcloudError('获取数据失败: ' + error.message);
                
                // 如果是库未加载的错误，尝试重新加载
                if (error.message.includes('词云库')) {
                    loadWordcloudLibrary();
                }
            } finally {
                wordcloudQueue = false;
            }
        }

        // 尝试重新加载词云库
        function loadWordcloudLibrary() {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/wordcloud2.js/1.2.1/wordcloud2.min.js';
            script.onload = function() {
                wordcloudLoaded = true;
                // 重新生成词云
                if (Object.keys(wordFrequency).length > 0) {
                    generateWordCloud();
                }
            };
            script.onerror = function() {
                console.error('词云库重新加载失败');
                showWordcloudError('词云库加载失败，请刷新页面重试');
            };
            document.head.appendChild(script);
        }

        // 显示词云错误
        function showWordcloudError(text) {
            wordcloudLoading.classList.add('hidden');
            wordcloudError.classList.remove('hidden');
            errorMessage.textContent = text;
        }

        // 显示消息
        function showMessage(text, type = 'default') {
            message.textContent = text;
            message.classList.remove('hidden', 'text-green-600', 'text-red-600', 'text-blue-600');
            
            switch(type) {
                case 'success':
                    message.classList.add('text-green-600');
                    break;
                case 'error':
                    message.classList.add('text-red-600');
                    break;
                case 'blue':
                    message.classList.add('text-blue-600');
                    break;
                default:
                    break;
            }
            
            setTimeout(() => {
                message.classList.add('hidden');
            }, 3000);
        }

        // 更新词语频率
        function updateWordFrequency(words) {
            const frequency = {};
            
            words.forEach(word => {
                const trimmedWord = word.trim();
                if (trimmedWord) {
                    frequency[trimmedWord] = (frequency[trimmedWord] || 0) + 1;
                }
            });
            
            wordFrequency = frequency;
            wordCount.textContent = words.length;
        }

        // 加载所有词语
        function loadAllWords() {
            query.find().then(results => {
                const words = results.map(result => result.get('word') || '').filter(Boolean);
                allWords = words;
                updateWordFrequency(words);
                generateWordCloud(); // 生成词云
                
                // 显示一些历史弹幕
                if (words.length > 0) {
                    const displayCount = Math.min(5, words.length);
                    for (let i = 0; i < displayCount; i++) {
                        const randomIndex = Math.floor(Math.random() * words.length);
                        setTimeout(() => {
                            addDanmaku(words[randomIndex]);
                        }, i * 1000);
                    }
                }
            }).catch(error => {
                console.error('加载数据错误:', error);
                showWordcloudError('获取数据失败: ' + error.message);
            });
        }

        // 提交词语
        function submitWord(word) {
            const newWord = new CareerIdealWord();
            newWord.set('word', word);
            
            return newWord.save().then(() => {
                // 标记为已提交
                localStorage.setItem('hasSubmitted', 'true');
                hasSubmitted = true;
                
                // 禁用输入
                wordInput.disabled = true;
                submitBtn.disabled = true;
                submitBtn.classList.add('bg-gray-400', 'hover:bg-gray-400', 'cursor-not-allowed');
                
                return true;
            }).catch(error => {
                console.error('提交错误:', error);
                throw new Error(error.message || '提交失败，请稍后再试');
            });
        }

        // 设置实时更新
        function setupRealtimeUpdates() {
            const query = new AV.Query(CareerIdealWord);
            const liveQuery = query.subscribe();
            
            liveQuery.on('create', (object) => {
                const newWord = object.get('word') || '';
                if (newWord.trim()) {
                    allWords.push(newWord);
                    updateWordFrequency(allWords);
                    generateWordCloud(); // 实时更新词云
                    addDanmaku(newWord, true); // 新提交的弹幕
                }
            });
        }

        // 表单提交事件
        wordForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const word = wordInput.value.trim();
            
            if (!word) {
                showMessage('请输入你的职业理想', 'error');
                return;
            }
            
            if (word.length > 10) {
                showMessage('请输入不超过10个字符的词语', 'error');
                return;
            }
            
            try {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa fa-spinner fa-spin"></i><span>提交中...</span>';
                
                await submitWord(word);
                showMessage('提交成功！感谢你的分享', 'success');
                wordInput.value = '';
                
                // 立即显示自己的弹幕
                addDanmaku(word, true);
                
            } catch (error) {
                showMessage(error.message, 'error');
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa fa-paper-plane"></i><span>提交</span>';
            }
        });

        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', () => {
            // 先检查词云库
            checkWordcloudLibrary().catch(error => {
                console.error('词云库检查失败:', error);
                showWordcloudError('词云库加载失败，正在尝试重新加载...');
                loadWordcloudLibrary(); // 尝试重新加载
            });
            
            // 加载已有数据
            loadAllWords();
            
            // 启动随机弹幕
            startRandomDanmaku();
            
            // 设置实时更新
            setupRealtimeUpdates();
            
            // 窗口大小变化时重新生成词云
            window.addEventListener('resize', () => {
                if (Object.keys(wordFrequency).length > 0) {
                    generateWordCloud();
                }
            });
        });
    </script>
</body>
</html>
