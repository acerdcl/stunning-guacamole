<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>班级职业理想词云</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/wordcloud@1.2.1/src/wordcloud.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/konva@9.3.6/konva.min.js"></script>
    
    <!-- 配置Tailwind自定义颜色和字体 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#4F46E5',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        neutral: '#6B7280',
                        light: '#F3F4F6',
                        dark: '#1F2937'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .text-shadow {
                text-shadow: 0 2px 4px rgba(0,0,0,0.1);
            }
            .card-shadow {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05), 0 4px 6px -2px rgba(0, 0, 0, 0.03);
            }
            .animate-float {
                animation: float 3s ease-in-out infinite;
            }
            @keyframes float {
                0% { transform: translateY(0px); }
                50% { transform: translateY(-10px); }
                100% { transform: translateY(0px); }
            }
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen font-sans">
    <!-- 页面标题 -->
    <header class="container mx-auto pt-8 pb-4 px-4 sm:px-6 lg:px-8">
        <div class="text-center">
            <h1 class="text-[clamp(1.8rem,5vw,3rem)] font-bold text-dark mb-2 text-shadow">
                班级职业理想共创
            </h1>
            <p class="text-neutral text-lg max-w-2xl mx-auto">
                输入并分享你的职业理想，共同创建我们班级的职业理想词云
            </p>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 sm:px-6 lg:px-8 pb-16">
        <!-- 输入区域 -->
        <section class="max-w-3xl mx-auto mb-8">
            <div class="bg-white rounded-xl p-6 card-shadow transition-all duration-300 hover:shadow-lg">
                <div class="flex flex-col sm:flex-row gap-3">
                    <input 
                        type="text" 
                        id="idealInput" 
                        placeholder="例如：自由、创新、稳定..." 
                        class="flex-1 px-4 py-3 rounded-lg border border-gray-300 focus:ring-2 focus:ring-primary/50 focus:border-primary outline-none transition-all"
                    >
                    <button 
                        id="submitBtn" 
                        class="bg-primary hover:bg-primary/90 text-white px-6 py-3 rounded-lg flex items-center justify-center gap-2 transition-all transform hover:scale-105 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed"
                    >
                        <i class="fa fa-paper-plane"></i>
                        <span>提交理想</span>
                    </button>
                </div>
                
                <!-- 管理按钮 -->
                <div class="mt-4 flex justify-end">
                    <button 
                        id="clearBtn" 
                        class="text-neutral hover:text-red-500 px-3 py-1 text-sm flex items-center gap-1 transition-colors"
                    >
                        <i class="fa fa-trash-o"></i>
                        <span>清除我的提交</span>
                    </button>
                </div>
            </div>
        </section>
        
        <!-- 词云展示区域 -->
        <section class="max-w-5xl mx-auto">
            <div class="bg-white rounded-xl p-6 card-shadow">
                <div class="flex items-center gap-2 mb-4">
                    <i class="fa fa-cloud text-primary text-xl"></i>
                    <h2 class="text-xl font-semibold text-dark">班级职业理想词云</h2>
                </div>
                
                <!-- 词云容器 -->
                <div id="wordcloudContainer" class="w-full h-[400px] border border-gray-200 rounded-lg overflow-hidden relative bg-gray-50">
                    <!-- 加载状态 -->
                    <div id="loadingIndicator" class="absolute inset-0 flex items-center justify-center bg-white/80 z-10 hidden">
                        <div class="text-center">
                            <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-primary border-t-transparent mb-2"></div>
                            <p class="text-neutral">正在生成词云...</p>
                        </div>
                    </div>
                    
                    <!-- 错误信息 -->
                    <div id="errorMessage" class="absolute inset-0 flex items-center justify-center text-red-500 hidden">
                        词云生成失败，请重试
                    </div>
                    
                    <!-- 空状态 -->
                    <div id="emptyState" class="absolute inset-0 flex flex-col items-center justify-center text-neutral">
                        <i class="fa fa-comment-o text-4xl mb-3 opacity-30"></i>
                        <p>还没有提交的职业理想，快来分享你的想法吧！</p>
                    </div>
                    
                    <!-- 词云画布 -->
                    <canvas id="wordcloudCanvas" class="w-full h-full"></canvas>
                </div>
                
                <!-- 数据统计 -->
                <div class="mt-4 flex flex-wrap gap-4 text-sm text-neutral">
                    <div class="flex items-center gap-1">
                        <i class="fa fa-users"></i>
                        <span>参与人数: <span id="participantCount">0</span></span>
                    </div>
                    <div class="flex items-center gap-1">
                        <i class="fa fa-tags"></i>
                        <span>理想词汇: <span id="wordCount">0</span></span>
                    </div>
                </div>
            </div>
        </section>
        
        <!-- 弹幕展示区 -->
        <section class="fixed bottom-0 left-0 right-0 h-24 pointer-events-none overflow-hidden z-10">
            <div id="danmakuContainer" class="w-full h-full relative"></div>
        </section>
    </main>

    <!-- 页脚 -->
    <footer class="bg-white py-4 border-t">
        <div class="container mx-auto px-4 text-center text-neutral text-sm">
            <p>班级职业理想共创平台 &copy; 2023</p>
        </div>
    </footer>

    <script>
        // 存储数据的键名
        const STORAGE_KEY = 'CareerIdealWord';
        
        // DOM元素
        const idealInput = document.getElementById('idealInput');
        const submitBtn = document.getElementById('submitBtn');
        const clearBtn = document.getElementById('clearBtn');
        const wordcloudContainer = document.getElementById('wordcloudContainer');
        const wordcloudCanvas = document.getElementById('wordcloudCanvas');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const emptyState = document.getElementById('emptyState');
        const participantCount = document.getElementById('participantCount');
        const wordCount = document.getElementById('wordCount');
        const danmakuContainer = document.getElementById('danmakuContainer');
        
        // 初始化页面
        document.addEventListener('DOMContentLoaded', () => {
            // 检查本地存储中的数据
            const savedData = getSavedData();
            updateUI(savedData);
            
            // 绑定事件
            submitBtn.addEventListener('click', handleSubmit);
            idealInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleSubmit();
            });
            clearBtn.addEventListener('click', handleClear);
            
            // 尝试生成词云
            if (savedData && savedData.words.length > 0) {
                generateWordCloud(savedData.words);
            }
        });
        
        // 从本地存储获取数据
        function getSavedData() {
            const data = localStorage.getItem(STORAGE_KEY);
            return data ? JSON.parse(data) : { words: [], myWords: [] };
        }
        
        // 保存数据到本地存储
        function saveData(data) {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }
        
        // 更新UI状态
        function updateUI(data) {
            // 更新统计信息
            const uniqueUsers = new Set(); // 简单模拟不同用户
            data.words.forEach(word => uniqueUsers.add(word.userId));
            participantCount.textContent = uniqueUsers.size;
            wordCount.textContent = data.words.length;
            
            // 更新按钮状态
            if (data.myWords.length > 0) {
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fa fa-check"></i><span>已提交</span>';
                clearBtn.classList.remove('hidden');
            } else {
                submitBtn.disabled = false;
                submitBtn.innerHTML = '<i class="fa fa-paper-plane"></i><span>提交理想</span>';
            }
            
            // 更新空状态
            if (data.words.length === 0) {
                emptyState.classList.remove('hidden');
                wordcloudCanvas.classList.add('hidden');
                errorMessage.classList.add('hidden');
            } else {
                emptyState.classList.add('hidden');
                wordcloudCanvas.classList.remove('hidden');
            }
        }
        
        // 处理提交
        function handleSubmit() {
            const inputText = idealInput.value.trim();
            
            if (!inputText) {
                showToast('请输入你的职业理想');
                return;
            }
            
            // 获取现有数据
            const data = getSavedData();
            
            // 检查是否已经提交过
            if (data.myWords.length > 0) {
                showToast('你已经提交过职业理想了');
                return;
            }
            
            // 生成唯一用户ID (实际应用中应该从登录系统获取)
            const userId = 'user_' + Date.now();
            
            // 分割输入的词汇
            const words = inputText.split(/、|，|,| /).filter(word => word.trim() !== '');
            
            if (words.length === 0) {
                showToast('请输入有效的词汇');
                return;
            }
            
            // 添加新词汇
            const newWords = words.map(word => ({
                text: word,
                count: 1,
                userId: userId
            }));
            
            data.myWords = newWords;
            data.words = [...data.words, ...newWords];
            
            // 保存数据
            saveData(data);
            
            // 更新UI
            updateUI(data);
            
            // 生成词云
            generateWordCloud(data.words);
            
            // 显示弹幕
            words.forEach(word => {
                addDanmaku(word);
            });
            
            // 清空输入框
            idealInput.value = '';
            
            showToast('提交成功！');
        }
        
        // 处理清除
        function handleClear() {
            if (!confirm('确定要清除你提交的职业理想吗？')) {
                return;
            }
            
            // 获取现有数据
            const data = getSavedData();
            
            // 过滤掉当前用户提交的词汇
            const myUserIds = new Set(data.myWords.map(word => word.userId));
            data.words = data.words.filter(word => !myUserIds.has(word.userId));
            
            // 清空我的词汇
            data.myWords = [];
            
            // 保存数据
            saveData(data);
            
            // 更新UI
            updateUI(data);
            
            // 重新生成词云
            if (data.words.length > 0) {
                generateWordCloud(data.words);
            } else {
                wordcloudCanvas.getContext('2d').clearRect(0, 0, wordcloudCanvas.width, wordcloudCanvas.height);
            }
            
            showToast('已清除你的提交');
        }
        
        // 生成词云
        function generateWordCloud(words) {
            // 显示加载状态
            loadingIndicator.classList.remove('hidden');
            errorMessage.classList.add('hidden');
            
            try {
                // 准备词云数据（合并相同词汇的计数）
                const wordCounts = {};
                words.forEach(word => {
                    const text = word.text.toLowerCase();
                    wordCounts[text] = (wordCounts[text] || 0) + word.count;
                });
                
                const wordList = Object.entries(wordCounts).map(([text, count]) => ({
                    text: text,
                    weight: count,
                    // 随机颜色
                    color: `hsl(${Math.random() * 360}, 70%, 60%)`
                }));
                
                // 设置画布尺寸
                wordcloudCanvas.width = wordcloudContainer.clientWidth;
                wordcloudCanvas.height = wordcloudContainer.clientHeight;
                
                // 清除现有内容
                const ctx = wordcloudCanvas.getContext('2d');
                ctx.clearRect(0, 0, wordcloudCanvas.width, wordcloudCanvas.height);
                
                // 生成词云
                setTimeout(() => { // 增加延迟，确保DOM已更新
                    try {
                        wordcloud(wordcloudCanvas, {
                            list: wordList,
                            gridSize: 12,
                            weightFactor: (size) => {
                                // 根据词频调整大小范围
                                return 10 + size * 5;
                            },
                            fontFamily: 'Inter, sans-serif',
                            color: (word, weight) => {
                                // 使用预先定义的颜色
                                return word.color;
                            },
                            rotateRatio: 0.5,
                            backgroundColor: 'transparent',
                            minSize: 8,
                            shuffle: true,
                            rotateSteps: 2,
                            drawOutOfBound: false,
                            shape: 'circle'
                        });
                        
                        // 隐藏加载状态
                        loadingIndicator.classList.add('hidden');
                    } catch (error) {
                        console.error('词云生成失败:', error);
                        loadingIndicator.classList.add('hidden');
                        errorMessage.classList.remove('hidden');
                    }
                }, 100);
                
            } catch (error) {
                console.error('词云处理失败:', error);
                loadingIndicator.classList.add('hidden');
                errorMessage.classList.remove('hidden');
            }
        }
        
        // 添加弹幕
        function addDanmaku(text) {
            const danmaku = document.createElement('div');
            danmaku.className = 'absolute whitespace-nowrap text-[clamp(14px,3vw,20px)] font-medium text-shadow animate-float';
            danmaku.textContent = text;
            
            // 随机样式
            const colors = ['#4F46E5', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'];
            danmaku.style.color = colors[Math.floor(Math.random() * colors.length)];
            danmaku.style.top = `${Math.random() * 70 + 10}%`;
            danmaku.style.right = '-300px';
            danmaku.style.opacity = Math.random() * 0.7 + 0.3;
            
            // 添加到容器
            danmakuContainer.appendChild(danmaku);
            
            // 动画
            const duration = Math.random() * 8 + 6; // 6-14秒
            let start = null;
            
            function animate(timestamp) {
                if (!start) start = timestamp;
                const progress = (timestamp - start) / (duration * 1000);
                
                if (progress < 1) {
                    const position = 100 - (progress * 130); // 从右到左移动
                    danmaku.style.transform = `translateX(${position}vw)`;
                    requestAnimationFrame(animate);
                } else {
                    danmaku.remove();
                }
            }
            
            requestAnimationFrame(animate);
        }
        
        // 显示提示消息
        function showToast(message) {
            // 检查是否已有toast
            let toast = document.querySelector('.toast-message');
            if (toast) {
                toast.remove();
            }
            
            // 创建新toast
            toast = document.createElement('div');
            toast.className = 'toast-message fixed top-4 right-4 bg-dark text-white px-4 py-2 rounded-lg shadow-lg z-50 transform transition-all duration-300 translate-x-full opacity-0';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            // 显示toast
            setTimeout(() => {
                toast.classList.remove('translate-x-full', 'opacity-0');
            }, 10);
            
            // 3秒后隐藏
            setTimeout(() => {
                toast.classList.add('translate-x-full', 'opacity-0');
                setTimeout(() => toast.remove(), 300);
            }, 3000);
        }
        
        // 窗口大小改变时重新生成词云
        window.addEventListener('resize', () => {
            const data = getSavedData();
            if (data && data.words.length > 0) {
                generateWordCloud(data.words);
            }
        });
    </script>
</body>
</html>
