<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>能力卡牌大作战</title>
    <!-- 引入外部资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.0/dist/av-min.js"></script>
    
    <style>
        /* 基础样式，避免依赖依赖Tailwind加载 */
        .card-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .skill-card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .skill-icon {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            margin: 0 auto 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e1e1e1;
        }
        
        .skill-icon i {
            font-size: 24px;
            color: #333;
        }
        
        .stars-container {
            margin: 10px 0;
        }
        
        .stars-container i {
            color: #ccc;
            cursor: pointer;
            margin: 0 2px;
            font-size: 18px;
        }
        
        .stars-container i.star-active {
            color: #F59E0B;
        }
        
        .vote-count {
            font-size: 14px;
            color: #666;
        }
    </style>
</head>
<body style="background-color: #f9f9f9; padding: 0; margin: 0; font-family: Arial, sans-serif;">
    <!-- 顶部导航 -->
    <header style="background-color: #3B82F6; color: white; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
        <div style="max-width: 1200px; margin: 0 auto; display: flex; justify-content: space-between; align-items: center;">
            <h1 style="margin: 0; font-size: 20px;"><i class="fa fa-gamepad"></i> 能力卡牌大作战</h1>
            <div>
                <span id="star-count" style="background-color: #F59E0B; padding: 5px 10px; border-radius: 20px; font-weight: bold; margin-right: 10px;">
                    剩余星星: <span id="remaining-stars">10</span>
                </span>
                <span id="vote-status" style="display: none; background-color: #10B981; padding: 5px 10px; border-radius: 4px; font-size: 14px;">
                    <i class="fa fa-check"></i> 已完成投票
                </span>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main style="max-width: 1200px; margin: 20px auto; padding: 0 15px;">
        <!-- 游戏说明 -->
        <div style="background: white; border-radius: 8px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
            <h2 style="margin-top: 0; color: #333;">游戏规则</h2>
            <p style="color: #666; margin-bottom: 0;">你有10颗星星，用于兑换你最想掌握的电商通用能力。点击卡牌上的星星来分配你的星星（最多5颗/卡牌），总数量不能超过10颗。提交后将实时显示班级排行榜。</p>
        </div>
        
        <div style="display: flex; flex-direction: column; gap: 20px;">
            <!-- 卡牌区域 - 移动优先设计 -->
            <div>
                <h2 style="color: #333; font-size: 18px;"><i class="fa fa-th-large"></i> 能力卡牌库</h2>
                <div id="cards-container" class="card-container">
                    <!-- 卡牌将通过JS直接生成 -->
                </div>
                
                <div style="text-align: center; margin: 20px 0;">
                    <button id="submit-vote" style="background-color: #3B82F6; color: white; border: none; padding: 10px 20px; border-radius: 20px; font-weight: bold; cursor: pointer; opacity: 0.5; pointer-events: none;">
                        <i class="fa fa-paper-plane"></i> 提交我的选择
                    </button>
                </div>
            </div>
            
            <!-- 排行榜区域 -->
            <div>
                <div style="background: white; border-radius: 8px; padding: 15px; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                    <h2 style="color: #333; font-size: 18px; margin-top: 0;"><i class="fa fa-trophy"></i> 实时排行榜</h2>
                    <div id="ranking-list" style="max-height: 400px; overflow-y: auto; margin-top: 15px;">
                        <div style="text-align: center; padding: 30px 0; color: #999;">
                            加载排行榜中...
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 投票成功弹窗 -->
    <div id="success-modal" style="display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); z-index: 100; align-items: center; justify-content: center;">
        <div style="background: white; border-radius: 8px; padding: 30px; max-width: 300px; width: 90%; text-align: center;">
            <div style="font-size: 50px; color: #10B981; margin-bottom: 15px;">
                <i class="fa fa-check-circle"></i>
            </div>
            <h3 style="margin: 0 0 10px; font-size: 20px;">投票成功！</h3>
            <p style="color: #666; margin-bottom: 20px;">你的投票已被记录，排行榜已更新</p>
            <button id="close-modal" style="background-color: #3B82F6; color: white; border: none; padding: 8px 20px; border-radius: 20px; font-weight: bold; cursor: pointer;">
                确定
            </button>
        </div>
    </div>

    <script>
        // 30个电商通用能力卡牌 - 优先定义，确保存在
        const skills = [
            "Excel", "Premiere", "Python基础", "谈判", "写文案",
            "数据分析", "Photoshop", "PPT制作", "市场调研", "SEO优化",
            "视频剪辑", "公众号运营", "直播技巧", "用户研究", "竞品分析",
            "UI设计", "SQL", "短视频策划", "电商运营", "社群运营",
            "供应链管理", "跨境电商", "内容创作", "活动策划", "品牌推广",
            "客户关系", "产品经理", "数据可视化", "新媒体营销", "转化率优化"
        ];

        // 全局变量 - 在页面加载前定义
        let voteData = {};
        let remainingStars = 10;
        let hasVoted = false;
        let userId = localStorage.getItem('skillCardUserId');
        
        // 初始化投票数据
        skills.forEach(skill => {
            voteData[skill] = 0;
        });

        // 确保用户ID存在
        if (!userId) {
            userId = 'user_' + Math.random().toString(36).substr(2, 9);
            localStorage.setItem('skillCardUserId', userId);
        }

        // 立即生成卡牌，不依赖任何外部加载
        function generateCardsImmediately() {
            const container = document.getElementById('cards-container');
            container.innerHTML = ''; // 清空容器
            
            // 为每个技能创建卡牌
            skills.forEach(skill => {
                // 创建卡牌元素
                const card = document.createElement('div');
                card.className = 'skill-card';
                card.innerHTML = `
                    <div class="skill-icon">
                        <i class="fa fa-cube"></i>
                    </div>
                    <h3 style="margin: 0 0 10px; font-size: 16px;">${skill}</h3>
                    <div class="stars-container">
                        <i class="fa fa-star" data-skill="${skill}" data-value="1"></i>
                        <i class="fa fa-star" data-skill="${skill}" data-value="2"></i>
                        <i class="fa fa-star" data-skill="${skill}" data-value="3"></i>
                        <i class="fa fa-star" data-skill="${skill}" data-value="4"></i>
                        <i class="fa fa-star" data-skill="${skill}" data-value="5"></i>
                    </div>
                    <div class="vote-count">
                        <i class="fa fa-star" style="color: #F59E0B;"></i> <span>0</span>
                    </div>
                `;
                container.appendChild(card);
            });
            
            // 绑定星星点击事件
            document.querySelectorAll('.stars-container i').forEach(star => {
                star.addEventListener('click', handleStarClick);
            });
            
            console.log('卡牌已生成，共', skills.length, '张');
        }

        // 立即生成卡牌，不等待任何资源加载
        generateCardsImmediately();

        // 页面完全加载后初始化其他功能
        window.onload = function() {
            console.log('页面完全加载，初始化其他功能');
            
            // 初始化LeanCloud
            try {
                AV.init({
                    appId: "uJ3KsasvmBzf9Xn2OodGclFx-gzGzoHsz",
                    appKey: "JEsdiH1q5v1NzqyLCLqJVWvt",
                    serverURLs: "https://uj3ksasv.lc-cn-n1-shared.com"
                });
                console.log('LeanCloud初始化成功');
            } catch (e) {
                console.error('LeanCloud初始化失败:', e);
                // 即使LeanCloud失败，卡牌仍能显示
            }

            // 定义Vote类
            let Vote;
            try {
                Vote = AV.Object.extend('Vote');
            } catch (e) {
                console.error('创建Vote类失败:', e);
            }

            // 检查用户是否已投票
            function checkIfVoted() {
                if (!Vote) return;
                
                const query = new AV.Query(Vote);
                query.equalTo('userId', userId);
                query.find().then(results => {
                    if (results.length > 0) {
                        hasVoted = true;
                        disableVoting();
                    }
                }).catch(error => {
                    console.error('检查投票状态失败:', error);
                });
            }

            // 禁用投票功能
            function disableVoting() {
                document.getElementById('star-count').style.display = 'none';
                document.getElementById('vote-status').style.display = 'inline-block';
                
                document.querySelectorAll('.stars-container i').forEach(star => {
                    star.style.cursor = 'default';
                    star.style.opacity = '0.7';
                });
                
                const submitBtn = document.getElementById('submit-vote');
                submitBtn.style.opacity = '0.5';
                submitBtn.style.pointerEvents = 'none';
            }

            // 处理星星点击事件
            function handleStarClick(e) {
                if (hasVoted) return;
                
                const skill = e.target.dataset.skill;
                const value = parseInt(e.target.dataset.value);
                const stars = document.querySelectorAll(`.stars-container i[data-skill="${skill}"]`);
                
                const previousVotes = voteData[skill];
                const difference = value - previousVotes;
                
                if (remainingStars - difference >= 0) {
                    // 更新剩余星星
                    remainingStars -= difference;
                    document.getElementById('remaining-stars').textContent = remainingStars;
                    
                    // 更新投票数据
                    voteData[skill] = value;
                    
                    // 更新星星显示
                    stars.forEach((star, index) => {
                        if (index < value) {
                            star.classList.add('star-active');
                        } else {
                            star.classList.remove('star-active');
                        }
                    });
                    
                    // 更新卡片计数
                    const card = e.target.closest('.skill-card');
                    card.querySelector('.vote-count span').textContent = value;
                    
                    // 更新提交按钮状态
                    const submitBtn = document.getElementById('submit-vote');
                    if (remainingStars < 10) {
                        submitBtn.style.opacity = '1';
                        submitBtn.style.pointerEvents = 'auto';
                    } else {
                        submitBtn.style.opacity = '0.5';
                        submitBtn.style.pointerEvents = 'none';
                    }
                }
            }

            // 提交投票
            function submitVote() {
                if (!Vote || remainingStars >= 10) return;
                
                const votePromises = [];
                
                skills.forEach(skill => {
                    if (voteData[skill] > 0) {
                        const vote = new Vote();
                        vote.set('userId', userId);
                        vote.set('skill', skill);
                        vote.set('stars', voteData[skill]);
                        votePromises.push(vote.save());
                    }
                });
                
                Promise.all(votePromises).then(() => {
                    hasVoted = true;
                    disableVoting();
                    document.getElementById('success-modal').style.display = 'flex';
                }).catch(error => {
                    console.error('提交投票失败:', error);
                    alert('提交失败，请重试');
                });
            }

            // 加载并监听投票数据
            function loadAndWatchVotes() {
                if (!Vote) return;
                
                const query = new AV.Query(Vote);
                
                try {
                    const subscription = query.subscribe();
                    
                    // 初始加载数据
                    loadVoteData(query);
                    
                    // 数据更新时重新加载
                    subscription.on('create', () => loadVoteData(query));
                    subscription.on('update', () => loadVoteData(query));
                } catch (e) {
                    console.error('设置数据监听失败:', e);
                    // 失败后仍尝试加载一次数据
                    loadVoteData(query);
                }
            }

            // 加载投票数据并更新排行榜
            function loadVoteData(query) {
                if (!query) return;
                
                query.find().then(results => {
                    const skillScores = {};
                    skills.forEach(skill => {
                        skillScores[skill] = 0;
                    });
                    
                    results.forEach(vote => {
                        const skill = vote.get('skill');
                        const stars = vote.get('stars');
                        if (skillScores[skill] !== undefined) {
                            skillScores[skill] += stars;
                        }
                    });
                    
                    updateRanking(skillScores);
                    updateCardScores(skillScores);
                }).catch(error => {
                    console.error('加载投票数据失败:', error);
                });
            }

            // 更新排行榜
            function updateRanking(skillScores) {
                const rankingList = document.getElementById('ranking-list');
                
                // 排序技能
                const sortedSkills = Object.entries(skillScores)
                    .sort((a, b) => b[1] - a[1]);
                
                // 清空排行榜
                rankingList.innerHTML = '';
                
                // 无数据情况
                if (sortedSkills.length === 0 || sortedSkills[0][1] === 0) {
                    rankingList.innerHTML = `
                        <div style="text-align: center; padding: 30px 0; color: #999;">
                            暂无投票数据，成为第一个投票的人吧！
                        </div>
                    `;
                    return;
                }
                
                // 生成排行榜项
                sortedSkills.forEach(([skill, score], index) => {
                    const item = document.createElement('div');
                    item.style.padding = '8px 10px';
                    item.style.borderBottom = '1px solid #eee';
                    item.style.display = 'flex';
                    item.style.justifyContent = 'space-between';
                    
                    // 前三名样式
                    if (index === 0) {
                        item.style.backgroundColor = '#fff9c4';
                    } else if (index === 1) {
                        item.style.backgroundColor = '#f5f5f5';
                    } else if (index === 2) {
                        item.style.backgroundColor = '#ffe0b2';
                    }
                    
                    let rankIcon = `${index + 1}.`;
                    if (index === 0) rankIcon = '<i class="fa fa-trophy" style="color: #FFD700;"></i>';
                    if (index === 1) rankIcon = '<i class="fa fa-trophy" style="color: #C0C0C0;"></i>';
                    if (index === 2) rankIcon = '<i class="fa fa-trophy" style="color: #CD7F32;"></i>';
                    
                    item.innerHTML = `
                        <div style="display: flex; align-items: center;">
                            <span style="margin-right: 8px;">${rankIcon}</span>
                            <span>${skill}</span>
                        </div>
                        <div style="color: #F59E0B; font-weight: bold;">
                            <i class="fa fa-star"></i> ${score}
                        </div>
                    `;
                    rankingList.appendChild(item);
                });
            }

            // 更新卡片上的总票数
            function updateCardScores(skillScores) {
                document.querySelectorAll('.skill-card').forEach(card => {
                    const skill = card.querySelector('h3').textContent;
                    const score = skillScores[skill] || 0;
                    card.querySelector('.vote-count span').textContent = score;
                });
            }

            // 绑定事件
            document.getElementById('submit-vote').addEventListener('click', submitVote);
            document.getElementById('close-modal').addEventListener('click', () => {
                document.getElementById('success-modal').style.display = 'none';
            });

            // 启动功能
            checkIfVoted();
            loadAndWatchVotes();
        };
    </script>
</body>
</html>
    
