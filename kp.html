<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èƒ½åŠ›å¡ç‰Œå¤§ä½œæˆ˜</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.8/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.0/dist/av-min.js"></script>
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#FF7A00',
                        secondary: '#165DFF',
                        star: '#FFD700'
                    }
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .card-hover {
                @apply transition-all duration-300 hover:shadow-lg hover:-translate-y-1;
            }
            .star-pulse {
                animation: pulse 1.5s infinite;
            }
            @keyframes pulse {
                0% { transform: scale(1); }
                50% { transform: scale(1.1); }
                100% { transform: scale(1); }
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <header class="bg-white shadow-md sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center space-x-2">
                <i class="fa fa-gamepad text-primary text-2xl"></i>
                <h1 class="text-xl font-bold text-primary">èƒ½åŠ›å¡ç‰Œå¤§ä½œæˆ˜</h1>
            </div>
            <div class="flex items-center space-x-4">
                <button id="toggleView" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                    <i class="fa fa-th-large text-secondary"></i>
                </button>
                <button id="toggleRank" class="p-2 rounded-full hover:bg-gray-100 transition-colors">
                    <i class="fa fa-trophy text-secondary"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-6">
        <!-- é”™è¯¯æç¤ºï¼ˆä»…åœ¨åˆå§‹åŒ–å¤±è´¥æ—¶æ˜¾ç¤ºï¼‰ -->
        <section id="errorMessage" class="bg-red-50 border border-red-200 text-red-700 rounded-xl p-4 mb-8 hidden">
            <div class="flex items-center">
                <i class="fa fa-exclamation-circle mr-2"></i>
                <p id="errorText">æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ</p>
            </div>
        </section>

        <!-- æ¸¸æˆè§„åˆ™ -->
        <section id="intro" class="bg-white rounded-xl shadow-sm p-6 mb-8">
            <h2 class="text-xl font-bold mb-3 text-secondary">ğŸŒŸ æ¸¸æˆè§„åˆ™</h2>
            <p class="mb-4">ä½ æœ‰10é¢—æ˜Ÿæ˜Ÿï¼Œå¯ä»¥æŠ•ç»™ä½ æœ€æƒ³å…‘æ¢çš„ç”µå•†æŠ€èƒ½ã€‚ç‚¹å‡»å¡ç‰Œä¸ºå…¶åˆ†é…æ˜Ÿæ˜Ÿï¼Œåˆ†é…å®Œæ¯•åæäº¤ä½ çš„é€‰æ‹©ï¼</p>
            <div class="flex items-center">
                <div class="flex">
                    <i class="fa fa-star text-star star-pulse"></i>
                    <i class="fa fa-star text-star star-pulse" style="animation-delay: 0.2s"></i>
                    <i class="fa fa-star text-star star-pulse" style="animation-delay: 0.4s"></i>
                </div>
                <span class="ml-2 text-gray-600">å‰©ä½™æ˜Ÿæ˜Ÿ: <span id="starsRemaining" class="font-bold text-primary">10</span></span>
            </div>
            <button id="submitVotes" class="mt-4 bg-primary hover:bg-primary/90 text-white py-2 px-6 rounded-lg transition-colors">
                æäº¤æˆ‘çš„é€‰æ‹©
            </button>
        </section>

        <!-- å¡ç‰Œåº“ -->
        <section id="cardsSection" class="mb-12">
            <h2 class="text-xl font-bold mb-4 text-secondary">èƒ½åŠ›å¡ç‰Œåº“</h2>
            <div id="cardsContainer" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                <!-- å¡ç‰Œå°†åŠ¨æ€ç”Ÿæˆ -->
            </div>
        </section>

        <!-- æ’è¡Œæ¦œ -->
        <section id="rankingSection" class="bg-white rounded-xl shadow-sm p-6 mb-8 hidden">
            <h2 class="text-xl font-bold mb-6 text-secondary">ç­çº§å®æ—¶æ’è¡Œæ¦œ</h2>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                <div class="lg:col-span-2">
                    <div id="rankingList" class="space-y-3 max-h-[500px] overflow-y-auto pr-2">
                        <!-- æ’è¡Œæ¦œå°†åŠ¨æ€ç”Ÿæˆ -->
                    </div>
                </div>
                <div>
                    <canvas id="rankingChart" width="400" height="300"></canvas>
                </div>
            </div>
        </section>

        <!-- æŠ•ç¥¨æˆåŠŸå¼¹çª— -->
        <section id="successMessage" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
            <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 text-center">
                <div class="text-5xl text-primary mb-4">
                    <i class="fa fa-check-circle"></i>
                </div>
                <h2 class="text-2xl font-bold mb-2">æŠ•ç¥¨æˆåŠŸï¼</h2>
                <p class="mb-6 text-gray-600">æ„Ÿè°¢ä½ çš„å‚ä¸ï¼Œä½ çš„æ˜Ÿæ˜Ÿå·²æˆåŠŸåˆ†é…ã€‚</p>
                <button id="viewResults" class="bg-secondary hover:bg-secondary/90 text-white py-2 px-6 rounded-lg transition-colors">
                    æŸ¥çœ‹ç­çº§æ’è¡Œæ¦œ
                </button>
            </div>
        </section>

        <!-- å·²æŠ•ç¥¨æç¤º -->
        <section id="alreadyVoted" class="bg-white rounded-xl shadow-sm p-6 mb-8 hidden">
            <div class="text-center">
                <div class="text-4xl text-primary mb-4">
                    <i class="fa fa-bar-chart"></i>
                </div>
                <h2 class="text-xl font-bold mb-2">ä½ å·²å®ŒæˆæŠ•ç¥¨</h2>
                <p class="mb-4 text-gray-600">æŸ¥çœ‹å½“å‰çš„ç­çº§æ’è¡Œæ¦œç»“æœ</p>
                <button id="showRankBtn" class="bg-secondary hover:bg-secondary/90 text-white py-2 px-6 rounded-lg transition-colors">
                    æŸ¥çœ‹æ’è¡Œæ¦œ
                </button>
            </div>
        </section>
    </main>

    <footer class="bg-gray-800 text-white py-6">
        <div class="container mx-auto px-4 text-center">
            <p>èƒ½åŠ›å¡ç‰Œå¤§ä½œæˆ˜ &copy; 2023</p>
        </div>
    </footer>

    <script>
        // LeanCloud é…ç½®ï¼ˆä½¿ç”¨ä½ æä¾›çš„ App ID å’Œ App Keyï¼‰
        const APP_ID = 'uJ3KsasvmBzf9Xn2OodGclFx-gzGzoHsz';
        const APP_KEY = 'JEsdiH1q5v1NzqyLCLqJVWvt';
        
        // æ ‡è®°æ˜¯å¦æˆåŠŸå¯ç”¨å®æ—¶ç›‘å¬
        let isLiveQueryEnabled = false;

        // åˆå§‹åŒ– LeanCloudï¼ˆå¸¦é”™è¯¯å¤„ç†ï¼‰
        try {
            AV.init({ 
                appId: APP_ID, 
                appKey: APP_KEY,
                serverURLs: 'https://uj3ksasv.lc-cn-n1-shared.com' // æ˜ç¡®æŒ‡å®šæœåŠ¡å™¨åœ°å€
            });
            console.log('LeanCloud åˆå§‹åŒ–æˆåŠŸ');
        } catch (error) {
            console.error('LeanCloud åˆå§‹åŒ–å¤±è´¥:', error);
            showError('æœåŠ¡å™¨è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œ');
        }

        // 30 ç§ç”µå•†èƒ½åŠ›å¡ç‰Œæ•°æ®
        const abilities = [
            { id: 1, name: 'Excel', icon: 'fa-table', color: 'bg-green-100 text-green-800' },
            { id: 2, name: 'Premiere', icon: 'fa-film', color: 'bg-purple-100 text-purple-800' },
            { id: 3, name: 'PythonåŸºç¡€', icon: 'fa-code', color: 'bg-blue-100 text-blue-800' },
            { id: 4, name: 'è°ˆåˆ¤', icon: 'fa-handshake-o', color: 'bg-amber-100 text-amber-800' },
            { id: 5, name: 'å†™æ–‡æ¡ˆ', icon: 'fa-pencil', color: 'bg-red-100 text-red-800' },
            { id: 6, name: 'æ•°æ®åˆ†æ', icon: 'fa-bar-chart', color: 'bg-indigo-100 text-indigo-800' },
            { id: 7, name: 'Photoshop', icon: 'fa-picture-o', color: 'bg-pink-100 text-pink-800' },
            { id: 8, name: 'çŸ­è§†é¢‘åˆ¶ä½œ', icon: 'fa-video-camera', color: 'bg-rose-100 text-rose-800' },
            { id: 9, name: 'SEOä¼˜åŒ–', icon: 'fa-search', color: 'bg-sky-100 text-sky-800' },
            { id: 10, name: 'ç¤¾ç¾¤è¿è¥', icon: 'fa-users', color: 'bg-emerald-100 text-emerald-800' },
            { id: 11, name: 'PPTåˆ¶ä½œ', icon: 'fa-file-powerpoint-o', color: 'bg-orange-100 text-orange-800' },
            { id: 12, name: 'å¸‚åœºè°ƒç ”', icon: 'fa-line-chart', color: 'bg-teal-100 text-teal-800' },
            { id: 13, name: 'ç”¨æˆ·ç”»åƒ', icon: 'fa-user', color: 'bg-lime-100 text-lime-800' },
            { id: 14, name: 'ç›´æ’­å¸¦è´§', icon: 'fa-microphone', color: 'bg-fuchsia-100 text-fuchsia-800' },
            { id: 15, name: 'è·¨å¢ƒç”µå•†', icon: 'fa-globe', color: 'bg-cyan-100 text-cyan-800' },
            { id: 16, name: 'ä¾›åº”é“¾ç®¡ç†', icon: 'fa-truck', color: 'bg-slate-100 text-slate-800' },
            { id: 17, name: 'å®¢æˆ·æœåŠ¡', icon: 'fa-headphones', color: 'bg-blue-100 text-blue-800' },
            { id: 18, name: 'å“ç‰Œç­–åˆ’', icon: 'fa-lightbulb-o', color: 'bg-amber-100 text-amber-800' },
            { id: 19, name: 'æ´»åŠ¨ç­–åˆ’', icon: 'fa-calendar', color: 'bg-rose-100 text-rose-800' },
            { id: 20, name: 'è´¢åŠ¡ç®¡ç†', icon: 'fa-money', color: 'bg-green-100 text-green-800' },
            { id: 21, name: 'Excelé«˜çº§', icon: 'fa-table', color: 'bg-green-100 text-green-800' },
            { id: 22, name: 'Pythonçˆ¬è™«', icon: 'fa-code', color: 'bg-blue-100 text-blue-800' },
            { id: 23, name: 'AIå·¥å…·åº”ç”¨', icon: 'fa-robot', color: 'bg-purple-100 text-purple-800' },
            { id: 24, name: 'æ•°æ®å¯è§†åŒ–', icon: 'fa-pie-chart', color: 'bg-indigo-100 text-indigo-800' },
            { id: 25, name: 'äº§å“è®¾è®¡', icon: 'fa-cube', color: 'bg-teal-100 text-teal-800' },
            { id: 26, name: 'å¾®ä¿¡è¿è¥', icon: 'fa-weixin', color: 'bg-green-100 text-green-800' },
            { id: 27, name: 'æŠ–éŸ³è¿è¥', icon: 'fa-music', color: 'bg-red-100 text-red-800' },
            { id: 28, name: 'é‚®ä»¶è¥é”€', icon: 'fa-envelope', color: 'bg-sky-100 text-sky-800' },
            { id: 29, name: 'ç«å“åˆ†æ', icon: 'fa-eye', color: 'bg-slate-100 text-slate-800' },
            { id: 30, name: 'é¡¹ç›®ç®¡ç†', icon: 'fa-tasks', color: 'bg-orange-100 text-orange-800' }
        ];

        // å…¨å±€å˜é‡
        let votes = {};           // å­˜å‚¨ç”¨æˆ·å½“å‰æŠ•ç¥¨
        let starsRemaining = 10;  // å‰©ä½™æ˜Ÿæ˜Ÿæ•°
        let allVotesData = [];    // æ‰€æœ‰æŠ•ç¥¨çš„ç»Ÿè®¡æ•°æ®
        let hasVoted = false;     // ç”¨æˆ·æ˜¯å¦å·²æŠ•ç¥¨
        // ç”¨æˆ·å”¯ä¸€æ ‡è¯†ï¼ˆä»æœ¬åœ°å­˜å‚¨è·å–ï¼Œæ— åˆ™ç”Ÿæˆï¼‰
        let userId = localStorage.getItem('abilityCardUserId') || ('user_' + Math.random().toString(36).substr(2, 9));
        localStorage.setItem('abilityCardUserId', userId);

        // DOM å…ƒç´ 
        const cardsContainer = document.getElementById('cardsContainer');
        const starsRemainingEl = document.getElementById('starsRemaining');
        const submitVotesBtn = document.getElementById('submitVotes');
        const successMessage = document.getElementById('successMessage');
        const viewResultsBtn = document.getElementById('viewResults');
        const rankingSection = document.getElementById('rankingSection');
        const rankingList = document.getElementById('rankingList');
        const toggleRankBtn = document.getElementById('toggleRank');
        const alreadyVotedEl = document.getElementById('alreadyVoted');
        const showRankBtn = document.getElementById('showRankBtn');
        const errorMessage = document.getElementById('errorMessage');
        const errorText = document.getElementById('errorText');
        const toggleViewBtn = document.getElementById('toggleView');

        // æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        // éšè—é”™è¯¯ä¿¡æ¯
        function hideError() {
            errorMessage.classList.add('hidden');
        }

        // åˆå§‹åŒ–é¡µé¢
        function init() {
            // åˆå§‹åŒ–æŠ•ç¥¨å¯¹è±¡ï¼ˆæ¯ä¸ªèƒ½åŠ›åˆå§‹å¾—ç¥¨ä¸º 0ï¼‰
            abilities.forEach(ability => {
                votes[ability.id] = 0;
            });
            
            // æ¸²æŸ“å¡ç‰Œ
            renderCards();
            
            // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æŠ•ç¥¨
            checkUserVoteStatus();
            
            // è·å–å¹¶**å®æ—¶ç›‘å¬**æ’è¡Œæ¦œæ•°æ®
            fetchAndListenToVotes();
            
            // ç»‘å®šæ‰€æœ‰äº¤äº’äº‹ä»¶
            bindEvents();
        }

        // ç»‘å®šæ‰€æœ‰äº¤äº’äº‹ä»¶
        function bindEvents() {
            // æäº¤æŠ•ç¥¨æŒ‰é’®
            submitVotesBtn.addEventListener('click', submitVotes);
            
            // æŠ•ç¥¨æˆåŠŸåâ€œæŸ¥çœ‹æ’è¡Œæ¦œâ€æŒ‰é’®
            viewResultsBtn.addEventListener('click', () => {
                successMessage.classList.add('hidden');
                showRanking();
            });
            
            // é¡¶éƒ¨â€œåˆ‡æ¢æ’è¡Œæ¦œâ€æŒ‰é’®
            toggleRankBtn.addEventListener('click', toggleRanking);
            
            // å·²æŠ•ç¥¨çŠ¶æ€ä¸‹â€œæŸ¥çœ‹æ’è¡Œæ¦œâ€æŒ‰é’®
            showRankBtn.addEventListener('click', showRanking);
            
            // â€œåˆ‡æ¢è§†å›¾ï¼ˆåˆ—è¡¨/ç½‘æ ¼ï¼‰â€æŒ‰é’®
            toggleViewBtn.addEventListener('click', toggleView);
        }

        // è·å–å¹¶**å®æ—¶ç›‘å¬**æŠ•ç¥¨æ•°æ®ï¼ˆæ ¸å¿ƒï¼šLiveQuery å®ç°è‡ªåŠ¨åˆ·æ–°ï¼‰
        function fetchAndListenToVotes() {
            try {
                const UserVote = AV.Object.extend('UserVote');
                const query = new AV.Query(UserVote);
                
                // åˆå§‹è·å–æ‰€æœ‰æŠ•ç¥¨æ•°æ®
                query.find().then(results => {
                    hideError(); // éšè—é”™è¯¯æç¤ºï¼ˆæ•°æ®å¼€å§‹åŠ è½½ï¼‰
                    processVotesData(results);
                }).catch(error => {
                    console.error('åˆå§‹è·å–æŠ•ç¥¨æ•°æ®å¤±è´¥:', error);
                    showError('åˆå§‹åŒ–æ’è¡Œæ¦œå¤±è´¥ï¼Œå¯å°è¯•æŸ¥çœ‹');
                });
                
                // å»ºç«‹å®æ—¶ç›‘å¬ï¼ˆLiveQueryï¼‰ï¼šå½“æ•°æ®å˜åŒ–æ—¶è‡ªåŠ¨æ›´æ–°
                const liveQuery = query.subscribe();
                liveQuery.on('update', () => {
                    query.find().then(processVotesData).catch(err => console.error('å®æ—¶æ›´æ–°å¤±è´¥:', err));
                });
                liveQuery.on('create', () => {
                    query.find().then(processVotesData).catch(err => console.error('å®æ—¶åˆ›å»ºå¤±è´¥:', err));
                });
                liveQuery.on('delete', () => {
                    query.find().then(processVotesData).catch(err => console.error('å®æ—¶åˆ é™¤å¤±è´¥:', err));
                });
                liveQuery.on('error', (err) => {
                    console.error('LiveQuery é”™è¯¯:', err);
                    showError('å®æ—¶æ›´æ–°å¼‚å¸¸ï¼Œæ’è¡Œæ¦œå°†æ‰‹åŠ¨åˆ·æ–°');
                });
                
                isLiveQueryEnabled = true;
                console.log('å®æ—¶ç›‘å¬å·²æˆåŠŸå¯ç”¨');
            } catch (error) {
                console.error('å»ºç«‹å®æ—¶ç›‘å¬å¤±è´¥:', error);
                showError('æ— æ³•å¯ç”¨å®æ—¶æ›´æ–°ï¼Œéœ€æ‰‹åŠ¨åˆ·æ–°æŸ¥çœ‹æ’è¡Œæ¦œ');
            }
        }

        // æ£€æŸ¥ç”¨æˆ·æ˜¯å¦å·²æŠ•ç¥¨
        function checkUserVoteStatus() {
            const UserVote = AV.Object.extend('UserVote');
            const query = new AV.Query(UserVote);
            query.equalTo('userId', userId);
            query.find().then(results => {
                if (results.length > 0) {
                    hasVoted = true;
                    showVotedView();
                }
            }).catch(error => {
                console.error('æ£€æŸ¥æŠ•ç¥¨çŠ¶æ€å¤±è´¥:', error);
            });
        }

        // æ˜¾ç¤ºâ€œå·²æŠ•ç¥¨â€è§†å›¾
        function showVotedView() {
            document.getElementById('intro').classList.add('hidden');
            alreadyVotedEl.classList.remove('hidden');
        }

        // æ¸²æŸ“èƒ½åŠ›å¡ç‰Œ
        function renderCards() {
            cardsContainer.innerHTML = ''; // æ¸…ç©ºå®¹å™¨
            
            abilities.forEach(ability => {
                const card = document.createElement('div');
                card.className = `bg-white rounded-lg shadow-sm p-4 card-hover border border-gray-100 ${hasVoted ? 'opacity-70' : ''}`;
                card.innerHTML = `
                    <div class="flex flex-col items-center justify-center h-full">
                        <div class="w-12 h-12 rounded-full ${ability.color} flex items-center justify-center mb-3">
                            <i class="fa ${ability.icon} text-xl"></i>
                        </div>
                        <h3 class="text-center font-medium text-sm mb-2">${ability.name}</h3>
                        <div class="flex items-center mt-auto">
                            <button class="minus-btn p-1 rounded-full bg-gray-100 hover:bg-gray-200 ${votes[ability.id] === 0 || hasVoted ? 'opacity-50 cursor-not-allowed' : ''}" data-id="${ability.id}">
                                <i class="fa fa-minus text-gray-600"></i>
                            </button>
                            <span class="vote-count mx-2 font-bold ${votes[ability.id] > 0 ? 'text-primary' : ''}" data-id="${ability.id}">${votes[ability.id]}</span>
                            <button class="plus-btn p-1 rounded-full bg-gray-100 hover:bg-gray-200 ${starsRemaining === 0 || hasVoted ? 'opacity-50 cursor-not-allowed' : ''}" data-id="${ability.id}">
                                <i class="fa fa-plus text-gray-600"></i>
                            </button>
                        </div>
                    </div>
                `;
                cardsContainer.appendChild(card);
            });
            
            // ç»‘å®šâ€œå¢åŠ æŠ•ç¥¨â€æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.plus-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (starsRemaining > 0 && !hasVoted) {
                        const id = parseInt(e.currentTarget.dataset.id);
                        votes[id]++;
                        starsRemaining--;
                        updateVoteUI(id);
                    }
                });
            });
            
            // ç»‘å®šâ€œå‡å°‘æŠ•ç¥¨â€æŒ‰é’®äº‹ä»¶
            document.querySelectorAll('.minus-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    if (!hasVoted) {
                        const id = parseInt(e.currentTarget.dataset.id);
                        if (votes[id] > 0) {
                            votes[id]--;
                            starsRemaining++;
                            updateVoteUI(id);
                        }
                    }
                });
            });
        }

        // æ›´æ–°æŠ•ç¥¨ UIï¼ˆæŒ‰é’®çŠ¶æ€ã€æ˜Ÿæ˜Ÿæ•°ã€å¾—ç¥¨æ•°ï¼‰
        function updateVoteUI(abilityId) {
            // æ›´æ–°å‰©ä½™æ˜Ÿæ˜Ÿæ•°æ˜¾ç¤º
            starsRemainingEl.textContent = starsRemaining;
            
            // æ›´æ–°å¡ç‰Œä¸Šçš„å¾—ç¥¨æ•°
            const voteCountEl = document.querySelector(`.vote-count[data-id="${abilityId}"]`);
            voteCountEl.textContent = votes[abilityId];
            voteCountEl.classList.toggle('text-primary', votes[abilityId] > 0);
            
            // æ›´æ–°â€œå‡å°‘æŠ•ç¥¨â€æŒ‰é’®çŠ¶æ€
            const minusBtn = document.querySelector(`.minus-btn[data-id="${abilityId}"]`);
            minusBtn.classList.toggle('opacity-50', votes[abilityId] === 0);
            minusBtn.classList.toggle('cursor-not-allowed', votes[abilityId] === 0);
            
            // æ›´æ–°æ‰€æœ‰â€œå¢åŠ æŠ•ç¥¨â€æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.plus-btn').forEach(btn => {
                btn.classList.toggle('opacity-50', starsRemaining === 0);
                btn.classList.toggle('cursor-not-allowed', starsRemaining === 0);
            });
        }

        // æäº¤æŠ•ç¥¨
        function submitVotes() {
            if (starsRemaining === 0) { // ç¡®ä¿ 10 é¢—æ˜Ÿæ˜Ÿå·²åˆ†é…å®Œæ¯•
                const UserVote = AV.Object.extend('UserVote');
                const userVote = new UserVote();
                userVote.set('userId', userId); // æ ‡è®°ç”¨æˆ·å”¯ä¸€ ID
                userVote.set('votes', votes);   // æäº¤å½“å‰æŠ•ç¥¨æ•°æ®
                
                userVote.save().then(() => {
                    hasVoted = true;
                    successMessage.classList.remove('hidden'); // æ˜¾ç¤ºâ€œæŠ•ç¥¨æˆåŠŸâ€å¼¹çª—
                }).catch(error => {
                    alert('æäº¤å¤±è´¥: ' + error.message);
                    console.error('æäº¤æŠ•ç¥¨å¤±è´¥:', error);
                });
            } else {
                alert('è¯·åˆ†é…å®Œ 10 é¢—æ˜Ÿæ˜Ÿå†æäº¤');
            }
        }

        // å¤„ç†æŠ•ç¥¨æ•°æ®ï¼ˆç»Ÿè®¡ã€æ’åºï¼‰
        function processVotesData(results) {
            const abilityTotals = {};
            abilities.forEach(ability => {
                abilityTotals[ability.id] = 0; // åˆå§‹åŒ–æ¯ä¸ªèƒ½åŠ›çš„æ€»å¾—ç¥¨æ•°ä¸º 0
            });
            
            // éå†æ‰€æœ‰ç”¨æˆ·çš„æŠ•ç¥¨ï¼Œç»Ÿè®¡æ€»å¾—ç¥¨
            results.forEach(result => {
                const votes = result.get('votes');
                for (const [id, count] of Object.entries(votes)) {
                    abilityTotals[id] = (abilityTotals[id] || 0) + count;
                }
            });
            
            // è½¬æ¢ä¸ºâ€œèƒ½åŠ› + æ€»å¾—ç¥¨â€çš„æ•°ç»„ï¼Œå¹¶æŒ‰å¾—ç¥¨ä»é«˜åˆ°ä½æ’åº
            allVotesData = abilities.map(ability => ({
                ...ability,
                total: abilityTotals[ability.id] || 0
            })).sort((a, b) => b.total - a.total);
            
            // æ›´æ–°æ’è¡Œæ¦œæ˜¾ç¤º
            updateRanking();
        }

        // æ›´æ–°æ’è¡Œæ¦œæ˜¾ç¤ºï¼ˆåˆ—è¡¨ + å›¾è¡¨ï¼‰
        function updateRanking() {
            rankingList.innerHTML = ''; // æ¸…ç©ºæ’è¡Œæ¦œå®¹å™¨
            
            allVotesData.forEach((ability, index) => {
                // æ˜¾ç¤ºâ€œæœ‰å¾—ç¥¨çš„èƒ½åŠ›â€æˆ–â€œå‰ 10 åèƒ½åŠ›â€
                if (ability.total > 0 || index < 10) {
                    const rankItem = document.createElement('div');
                    rankItem.className = `flex items-center p-3 rounded-lg ${index < 3 ? 'bg-gray-50' : 'hover:bg-gray-50'} transition-colors`;
                    
                    // å‰ä¸‰åæ˜¾ç¤ºâ€œå¥–æ¯â€å›¾æ ‡ï¼Œå…¶ä½™æ˜¾ç¤ºâ€œæ’åæ•°å­—â€
                    let rankIcon = '';
                    if (index === 0) {
                        rankIcon = '<i class="fa fa-trophy text-yellow-500 mr-2"></i>';
                    } else if (index === 1) {
                        rankIcon = '<i class="fa fa-trophy text-gray-400 mr-2"></i>';
                    } else if (index === 2) {
                        rankIcon = '<i class="fa fa-trophy text-amber-700 mr-2"></i>';
                    } else {
                        rankIcon = `<span class="w-6 text-center mr-2 text-gray-500">${index + 1}</span>`;
                    }
                    
                    rankItem.innerHTML = `
                        ${rankIcon}
                        <div class="w-8 h-8 rounded-full ${ability.color} flex items-center justify-center flex-shrink-0">
                            <i class="fa ${ability.icon}"></i>
                        </div>
                        <div class="ml-3 flex-grow">
                            <div class="font-medium">${ability.name}</div>
                            <div class="w-full bg-gray-200 rounded-full h-2 mt-1">
                                <div class="bg-primary h-2 rounded-full" style="width: ${calculatePercentage(ability.total)}%"></div>
                            </div>
                        </div>
                        <div class="ml-2 font-bold text-primary">${ability.total} <i class="fa fa-star text-star"></i></div>
                    `;
                    rankingList.appendChild(rankItem);
                }
            });
            
            // æ›´æ–°æ’è¡Œæ¦œå›¾è¡¨
            updateChart();
        }

        // è®¡ç®—å¾—ç¥¨ç™¾åˆ†æ¯”ï¼ˆç”¨äºè¿›åº¦æ¡å®½åº¦ï¼‰
        function calculatePercentage(value) {
            if (allVotesData.length === 0) return 0;
            const maxVote = allVotesData[0].total; // æœ€é«˜å¾—ç¥¨æ•°
            return maxVote > 0 ? Math.min(100, (value / maxVote) * 100) : 0;
        }

        // æ›´æ–°æ’è¡Œæ¦œå›¾è¡¨ï¼ˆæ˜¾ç¤ºå‰ 5 åï¼‰
        function updateChart() {
            const ctx = document.getElementById('rankingChart').getContext('2d');
            const top5Abilities = allVotesData.slice(0, 5); // å–å‰ 5 å
            
            // é”€æ¯æ—§å›¾è¡¨ï¼ˆé¿å…é‡å¤æ¸²æŸ“ï¼‰
            if (window.rankingChart) window.rankingChart.destroy();
            
            // åˆ›å»ºæ–°å›¾è¡¨
            window.rankingChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top5Abilities.map(ability => ability.name), // X è½´ï¼šèƒ½åŠ›åç§°
                    datasets: [{
                        label: 'æ˜Ÿæ˜Ÿæ•°é‡',
                        data: top5Abilities.map(ability => ability.total), // Y è½´ï¼šå¾—ç¥¨æ•°
                        backgroundColor: top5Abilities.map(ability => {
                            // æ˜ å°„å¡ç‰Œé¢œè‰²åˆ°å›¾è¡¨é¢œè‰²
                            const colorMap = {
                                'bg-green-100': 'rgba(110, 231, 183, 0.7)',
                                'bg-purple-100': 'rgba(216, 180, 254, 0.7)',
                                'bg-blue-100': 'rgba(191, 219, 254, 0.7)',
                                'bg-amber-100': 'rgba(252, 231, 166, 0.7)',
                                'bg-red-100': 'rgba(254, 202, 202, 0.7)',
                                'bg-indigo-100': 'rgba(224, 231, 255, 0.7)',
                            };
                            return colorMap[ability.color] || 'rgba(255, 122, 0, 0.7)'; // é»˜è®¤æ©™è‰²
                        }),
                        borderWidth: 0,
                        borderRadius: 4 // æŸ±çŠ¶å›¾åœ†è§’
                    }]
                },
                options: {
                    responsive: true,        // å“åº”å¼ï¼ˆé€‚é…æ‰‹æœºï¼‰
                    maintainAspectRatio: false, // ä¸å¼ºåˆ¶ä¿æŒå®½é«˜æ¯”
                    plugins: { legend: { display: false } }, // éšè—å›¾ä¾‹
                    scales: {
                        y: { 
                            beginAtZero: true, // Y è½´ä» 0 å¼€å§‹
                            grid: { color: 'rgba(0, 0, 0, 0.05)' } // ç½‘æ ¼çº¿é€æ˜
                        },
                        x: { grid: { display: false } } // éšè— X è½´ç½‘æ ¼çº¿
                    }
                }
            });
        }

        // æ˜¾ç¤ºæ’è¡Œæ¦œ
        function showRanking() {
            rankingSection.classList.remove('hidden'); // æ˜¾ç¤ºæ’è¡Œæ¦œ
            cardsContainer.classList.add('hidden');    // éšè—å¡ç‰Œåº“
        }

        // åˆ‡æ¢â€œæ˜¾ç¤º/éšè—â€æ’è¡Œæ¦œ
        function toggleRanking() {
            rankingSection.classList.toggle('hidden');
            cardsContainer.classList.toggle('hidden');
        }

        // åˆ‡æ¢è§†å›¾ï¼ˆç½‘æ ¼å¸ƒå±€ â†” åˆ—è¡¨å¸ƒå±€ï¼‰
        function toggleView() {
            const isGridLayout = cardsContainer.classList.contains('grid-cols-2');
            if (isGridLayout) {
                // åˆ‡æ¢ä¸ºâ€œåˆ—è¡¨å¸ƒå±€â€
                cardsContainer.classList.remove('grid-cols-2', 'sm:grid-cols-3', 'md:grid-cols-4', 'lg:grid-cols-5', 'xl:grid-cols-6');
                cardsContainer.classList.add('grid-cols-1');
                toggleViewBtn.innerHTML = '<i class="fa fa-list text-secondary"></i>';
            } else {
                // åˆ‡æ¢ä¸ºâ€œç½‘æ ¼å¸ƒå±€â€
                cardsContainer.classList.add('grid-cols-2', 'sm:grid-cols-3', 'md:grid-cols-4', 'lg:grid-cols-5', 'xl:grid-cols-6');
                cardsContainer.classList.remove('grid-cols-1');
                toggleViewBtn.innerHTML = '<i class="fa fa-th-large text-secondary"></i>';
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
