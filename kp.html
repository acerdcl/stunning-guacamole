<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>能力卡牌大作战</title>
    <!-- 引入外部资源 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.13.0/dist/av-min.js"></script>
    
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: '#3B82F6',
                        secondary: '#10B981',
                        accent: '#F59E0B',
                        dark: '#1F2937',
                        light: '#F9FAFB'
                    },
                    fontFamily: {
                        sans: ['Inter', 'system-ui', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <!-- 自定义工具类 -->
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .card-shadow {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
            .card-hover {
                transition: all 0.3s ease;
            }
            .card-hover:hover {
                transform: translateY(-5px);
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
            .star-active {
                color: #F59E0B;
                transform: scale(1.1);
                transition: all 0.2s ease;
            }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- 顶部导航 -->
    <header class="bg-primary text-white shadow-md">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <h1 class="text-2xl font-bold">
                <i class="fa fa-gamepad mr-2"></i>能力卡牌大作战
            </h1>
            <div class="flex items-center">
                <span id="star-count" class="bg-accent px-3 py-1 rounded-full font-bold mr-2">
                    剩余星星: <span id="remaining-stars">10</span>
                </span>
                <span id="vote-status" class="hidden text-sm bg-green-500 px-2 py-1 rounded">
                    <i class="fa fa-check"></i> 已完成投票
                </span>
            </div>
        </div>
    </header>

    <!-- 主内容区 -->
    <main class="container mx-auto px-4 py-6">
        <!-- 游戏说明 -->
        <div class="bg-white rounded-lg shadow-md p-4 mb-6">
            <h2 class="text-xl font-semibold mb-2 text-dark">游戏规则</h2>
            <p class="text-gray-600">你有10颗星星，用于兑换你最想掌握的电商通用能力。点击卡牌上的星星来分配你的星星，总数量不能超过10颗。提交后将实时显示班级排行榜。</p>
        </div>
        
        <div class="flex flex-col lg:flex-row gap-6">
            <!-- 卡牌区域 -->
            <div class="lg:w-2/3">
                <h2 class="text-xl font-semibold mb-4 text-dark flex items-center">
                    <i class="fa fa-th-large mr-2 text-primary"></i>能力卡牌
                    <span id="card-count" class="ml-2 text-sm bg-gray-200 px-2 py-1 rounded-full">0/30</span>
                </h2>
                <div id="cards-container" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                    <!-- 卡牌将通过JS动态生成 -->
                    <div class="col-span-full text-center py-12 text-gray-500">
                        <i class="fa fa-circle-o-notch fa-spin text-3xl mb-3"></i>
                        <p>正在初始化系统...</p>
                    </div>
                </div>
                
                <div class="mt-6 text-center">
                    <button id="submit-vote" class="bg-primary hover:bg-primary/90 text-white font-bold py-3 px-8 rounded-full shadow-md disabled:opacity-50 disabled:cursor-not-allowed transition-all" disabled>
                        <i class="fa fa-paper-plane mr-2"></i>提交我的选择
                    </button>
                </div>
            </div>
            
            <!-- 排行榜区域 -->
            <div class="lg:w-1/3">
                <div class="bg-white rounded-lg shadow-md p-4 sticky top-4">
                    <h2 class="text-xl font-semibold mb-4 text-dark flex items-center">
                        <i class="fa fa-trophy mr-2 text-accent"></i>实时排行榜
                    </h2>
                    <div id="ranking-list" class="space-y-3 max-h-[600px] overflow-y-auto pr-2">
                        <!-- 排行榜将通过JS动态生成 -->
                        <div class="flex justify-center items-center h-60 text-gray-400">
                            <i class="fa fa-spinner fa-spin text-3xl"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- 页脚 -->
    <footer class="bg-dark text-white mt-10 py-6">
        <div class="container mx-auto px-4 text-center">
            <p>能力卡牌大作战 &copy; 2023</p>
        </div>
    </footer>

    <!-- 投票成功弹窗 -->
    <div id="success-modal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 hidden">
        <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4 text-center">
            <div class="text-5xl text-green-500 mb-4">
                <i class="fa fa-check-circle"></i>
            </div>
            <h3 class="text-xl font-bold mb-2">投票成功！</h3>
            <p class="text-gray-600 mb-4">你的投票已被记录，排行榜已更新</p>
            <button id="close-modal" class="bg-primary hover:bg-primary/90 text-white font-bold py-2 px-6 rounded-full">
                确定
            </button>
        </div>
    </div>

    <script>
        // 全局变量
        let voteData = {}; // 存储用户的投票数据
        let remainingStars = 10; // 剩余星星数量
        let hasVoted = false; // 用户是否已投票
        let userId = localStorage.getItem('skillCardUserId'); // 用户ID
        const cardsContainer = document.getElementById('cards-container');
        const cardCountElement = document.getElementById('card-count');
        const remainingStarsElement = document.getElementById('remaining-stars');
        const submitButton = document.getElementById('submit-vote');

        // 30个电商通用能力卡牌
        const skills = [
            "Excel", "Premiere", "Python基础", "谈判", "写文案",
            "数据分析", "Photoshop", "PPT制作", "市场调研", "SEO优化",
            "视频剪辑", "公众号运营", "直播技巧", "用户研究", "竞品分析",
            "UI设计", "SQL", "短视频策划", "电商运营", "社群运营",
            "供应链管理", "跨境电商", "内容创作", "活动策划", "品牌推广",
            "客户关系", "产品经理", "数据可视化", "新媒体营销", "转化率优化"
        ];

        // 初始化用户ID（确保每个用户唯一）
        if (!userId) {
            userId = AV.Object._createObjectId();
            localStorage.setItem('skillCardUserId', userId);
        }

        // 初始化应用
        async function initApp() {
            try {
                // 初始化LeanCloud
                await new Promise((resolve) => {
                    AV.init({
                        appId: "uJ3KsasvmBzf9Xn2OodGclFx-gzGzoHsz",
                        appKey: "JEsdiH1q5v1NzqyLCLqJVWvt",
                        serverURLs: "https://uj3ksasv.lc-cn-n1-shared.com"
                    });
                    resolve();
                });

                // 获取Vote数据模型
                const Vote = AV.Object.extend('Vote');
                
                // 生成能力卡牌
                generateCards();
                
                // 检查用户是否已投票
                await checkIfVoted(Vote);
                
                // 加载并监听投票数据
                loadAndWatchVotes(Vote);
                
                // 绑定事件处理
                bindEvents();

            } catch (error) {
                console.error('应用初始化失败:', error);
                cardsContainer.innerHTML = `
                    <div class="col-span-full text-center py-12 text-red-500">
                        <i class="fa fa-exclamation-triangle text-3xl mb-3"></i>
                        <p>系统初始化失败，请刷新页面重试</p>
                        <p class="text-sm mt-2">错误信息: ${error.message}</p>
                    </div>
                `;
            }
        }

        // 生成能力卡牌
        function generateCards() {
            // 清空容器
            cardsContainer.innerHTML = '';
            
            // 初始化投票数据
            skills.forEach(skill => {
                voteData[skill] = 0;
            });
            
            let cardsCreated = 0;
            
            // 创建卡牌
            skills.forEach(skill => {
                try {
                    const card = document.createElement('div');
                    card.className = 'bg-white rounded-lg shadow-md p-4 card-shadow card-hover';
                    card.innerHTML = `
                        <h3 class="font-semibold text-lg mb-2 text-dark">${skill}</h3>
                        <div class="flex justify-between items-center">
                            <div class="stars-container flex">
                                ${[...Array(5)].map((_, i) => `
                                    <i class="fa fa-star text-gray-300 cursor-pointer text-xl mx-1" 
                                       data-skill="${skill}" 
                                       data-value="${i + 1}"></i>
                                `).join('')}
                            </div>
                            <span class="vote-count bg-gray-100 px-2 py-1 rounded text-sm">
                                <i class="fa fa-star text-accent"></i> <span>0</span>
                            </span>
                        </div>
                    `;
                    cardsContainer.appendChild(card);
                    cardsCreated++;
                    
                    // 绑定星星星星点击事件
                    const stars = card.querySelectorAll('.fa-star[data-skill]');
                    stars.forEach(star => {
                        star.addEventListener('click', handleStarClick);
                    });
                } catch (error) {
                    console.error('生成卡牌失败（' + skill + '）:', error);
                }
            });
            
            // 更新卡牌计数
            cardCountElement.textContent = `${cardsCreatedsCreated}/${skills.length}`;
        }

        // 处理星星点击事件
        function handleStarClick(e) {
            if (hasVoted) return;
            
            const skill = e.target.dataset.skill;
            const value = parseInt(e.target.dataset.value);
            const stars = document.querySelectorAll(`.fa-star[data-skill="${skill}"]`);
            
            // 计算星星变化量
            const previousVotes = voteData[skill];
            const difference = value - previousVotes;
            
            // 检查是否有足够的星星
            if (remainingStars - difference >= 0) {
                // 更新剩余星星
                remainingStars -= difference;
                remainingStarsElement.textContent = remainingStars;
                
                // 更新投票数据
                voteData[skill] = value;
                
                // 更新星星显示状态
                stars.forEach((star, index) => {
                    if (index < value) {
                        star.classList.add('text-accent', 'star-active');
                        star.classList.remove('text-gray-300');
                    } else {
                        star.classList.remove('text-accent', 'star-active');
                        star.classList.add('text-gray-300');
                    }
                });
                
                // 更新卡片计数
                const countElement = e.target.closest('.card-shadow').querySelector('.vote-count span');
                if (countElement) countElement.textContent = value;
                
                // 更新提交按钮状态
                updateSubmitButtonState();
            }
        }

        // 更新提交按钮状态
        function updateSubmitButtonState() {
            submitButton.disabled = remainingStars === 10;
        }

        // 检查用户是否已投票
        async function checkIfVoted(VoteClass) {
            try {
                const query = new AV.Query(VoteClass);
                query.equalTo('userId', userId);
                const results = await query.find();
                
                if (results.length > 0) {
                    hasVoted = true;
                    disableVoting();
                }
            } catch (error) {
                console.error('检查投票状态失败:', error);
            }
        }

        // 禁用投票功能
        function disableVoting() {
            // 更新UI状态
            document.getElementById('star-count').classList.add('hidden');
            document.getElementById('vote-status').classList.remove('hidden');
            
            // 禁用交互元素
            document.querySelectorAll('.fa-star[data-skill]').forEach(star => {
                star.classList.remove('cursor-pointer');
                star.classList.add('opacity-70');
            });
            submitButton.disabled = true;
        }

        // 提交投票
        async function submitVote() {
            if (remainingStars < 10 && remainingStars >= 0) {
                try {
                    const VoteClass = AV.Object.extend('Vote');
                    const votePromises = [];
                    
                    // 收集所有投票
                    skills.forEach(skill => {
                        if (voteData[skill] > 0) {
                            const vote = new VoteClass();
                            vote.set('userId', userId);
                            vote.set('skill', skill);
                            vote.set('stars', voteData[skill]);
                            votePromises.push(vote.save());
                        }
                    });
                    
                    // 提交所有投票
                    await Promise.all(votePromises);
                    
                    // 更新状态
                    hasVoted = true;
                    disableVoting();
                    document.getElementById('success-modal').classList.remove('hidden');
                } catch (error) {
                    console.error('提交投票失败:', error);
                    alert('提交失败，请重试');
                }
            }
        }

        // 加载并监听投票数据
        function loadAndWatchVotes(VoteClass) {
            try {
                const query = new AV.Query(VoteClass);
                
                // 实时监听数据变化
                const subscription = query.subscribe();
                
                // 初始加载
                loadVoteData(query);
                
                // 数据变化时更新
                subscription.on('create', () => loadVoteData(query));
                subscription.on('update', () => loadVoteData(query));
                subscription.on('delete', () => loadVoteData(query));
            } catch (error) {
                console.error('设置数据监听失败:', error);
            }
        }

        // 加载投票数据并更新排行榜
        async function loadVoteData(query) {
            try {
                const results = await query.find();
                
                // 计算每个技能的总得票数
                const skillScores = {};
                skills.forEach(skill => {
                    skillScores[skill] = 0;
                });
                
                results.forEach(vote => {
                    const skill = vote.get('skill');
                    const stars = vote.get('stars');
                    if (skillScores[skill] !== undefined) {
                        skillScores[skill] += stars;
                    }
                });
                
                // 更新排行榜和卡牌显示
                updateRanking(skillScores);
                updateCardScores(skillScores);
            } catch (error) {
                console.error('加载投票数据失败:', error);
            }
        }

        // 更新排行榜
        function updateRanking(skillScores) {
            const rankingList = document.getElementById('ranking-list');
            rankingList.innerHTML = '';
            
            // 排序技能
            const sortedSkills = Object.entries(skillScores)
                .sort((a, b) => b[1] - a[1])
                .filter(([_, score]) => score > 0);
            
            // 无数据状态
            if (sortedSkills.length === 0) {
                rankingList.innerHTML = `
                    <div class="text-center text-gray-400 py-8">
                        暂无投票数据，成为第一个投票的人吧！
                    </div>
                `;
                return;
            }
            
            // 生成排行榜项
            sortedSkills.forEach(([skill, score], index) => {
                const item = document.createElement('div');
                let rankClass = '';
                let rankIcon = '';
                
                // 前三名样式
                if (index === 0) {
                    rankClass = 'bg-yellow-50 border-yellow-200';
                    rankIcon = '<i class="fa fa-trophy text-yellow-500 mr-2"></i>';
                } else if (index === 1) {
                    rankClass = 'bg-gray-50 border-gray-200';
                    rankIcon = '<i class="fa fa-trophy text-gray-400 mr-2"></i>';
                } else if (index === 2) {
                    rankClass = 'bg-orange-50 border-orange-200';
                    rankIcon = '<i class="fa fa-trophy text-orange-600 mr-2"></i>';
                } else {
                    rankClass = 'bg-white border-gray-100';
                    rankIcon = `<span class="text-gray-500 mr-2">${index + 1}.</span>`;
                }
                
                item.className = `flex justify-between items-center p-3 rounded-lg border ${rankClass}`;
                item.innerHTML = `
                    <div class="flex items-center">
                        ${rankIcon}
                        <span class="font-medium">${skill}</span>
                    </div>
                    <div class="flex items-center text-accent font-bold">
                        <i class="fa fa-star mr-1"></i> ${score}
                    </div>
                `;
                rankingList.appendChild(item);
            });
        }

        // 更新卡牌上的总票数
        function updateCardScores(skillScores) {
            document.querySelectorAll('#cards-container > div').forEach(card => {
                const skill = card.querySelector('h3').textContent;
                const score = skillScores[skill] || 0;
                const countElement = card.querySelector('.vote-count span');
                if (countElement) countElement.textContent = score;
            });
        }

        // 绑定事件处理函数
        function bindEvents() {
            submitButton.addEventListener('click', submitVote);
            document.getElementById('close-modal').addEventListener('click', () => {
                document.getElementById('success-modal').classList.add('hidden');
            });
        }

        // 页面加载完成后初始化应用
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
    
